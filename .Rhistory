# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
ls()
summary(McGarrydat)
head(all.sub)
mytable(all.sub$Hours, all.main$Folder[match(all.sub$ID, all.main$ID)])
mytable(round(all.sub$Hours), all.main$Folder[match(all.sub$ID, all.main$ID)])
head(Sub)
head(Main)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
as.numeric(sdt)
sdt
sdt[1:10]
mdt[1:10]
paste(Main1$Start_Date, Main1$Start_Time)
head(Main1)
 strsplit(Main1$Start_Date, " ")
sapply(strsplit(Main1$Start_Date, " "), "[", 1)
sapply(strsplit(Main1$Start_Time, " "), "[", 2)
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
mdt
head(Sub)
head(Sub1)
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Main1$Check_Date <- sapply(strsplit(Main1$Check_Date, " "), "[", 1)
Main1$Check_Time <- sapply(strsplit(Main1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
search()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"ph", "pH", 
"start.date", "Start_Date", 
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
head(Main1)
head(Sub1)
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.sub$Hours, all.main$Folder[match(all.sub$ID, all.main$ID)])
mytable(round(all.sub$Hours), all.main$Folder[match(all.sub$ID, all.main$ID)])
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[all.sub$ID %in% ids, ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main)
head(sub)
### determine what concentration and pH values to use
replaceval <- function(id, best1, best2, best3) {
# start with the line-by-line value
usethis <- best1
# but, when an ID has ANY missing values
idnoconc <- sort(unique(id[is.na(best1)]))
# use the target value, instead
usethis[id %in% idnoconc] <- best2[id %in% idnoconc]
# if the target value was also missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(best2)]))
both <- intersect(idnoconc, idnotarg)
usethis[id %in% both] <- best3[id %in% both]
usethis
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), mean, na.rm=TRUE))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, concentration_t, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_t, pH_Target, pH_mean))
graphics.off()
plot(sub$Hours)
table(sub$Hours)
sort(unique(sub$Hours))
sub$ID[sub$Hours<0.1
]
sub$ID[sub$Hours<0.1]
unique(sub$ID[sub$Hours<0.1])
# wacky hours
hid <- unique(sub$ID[sub$Hours<0.1])
main[main$ID %in% hid, ]
# wacky hours
hid <- unique(sub$ID[sub$Hours<0.1])
main[main$ID %in% hid, c("ID", "Start_Date", "Start_Time")]
sub[sub$ID %in% hid, c("ID", "Check_Date", "Check_Time")]
i <- 1
main[main$ID==hid[i], c("ID", "Start_Date", "Start_Time")]
sub[sub$ID==hid[i], c("ID", "Check_Date", "Check_Time", "Hours")]
hid
hid
main[main$ID==12776, ]
sub[sub$ID==12776, ]
search()
cleanup()
graphics.off()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
ids
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[all.sub$ID %in% ids, ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main)
head(sub)
main[main$ID==12776, ]
sub[sub$ID==12776, ]
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main)
head(sub)
sub[sub$ID==12776, ]
### determine what concentration and pH values to use
replaceval <- function(id, best1, best2, best3) {
# start with the line-by-line value
usethis <- best1
# but, when an ID has ANY missing values
idnoconc <- sort(unique(id[is.na(best1)]))
# use the target value, instead
usethis[id %in% idnoconc] <- best2[id %in% idnoconc]
# if the target value was also missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(best2)]))
both <- intersect(idnoconc, idnotarg)
usethis[id %in% both] <- best3[id %in% both]
usethis
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), mean, na.rm=TRUE))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, concentration_t, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_t, pH_Target, pH_mean))
# wacky hours
hid <- unique(sub$ID[sub$Hours<0.1])
i <- 1
main[main$ID==hid[i], c("ID", "Start_Date", "Start_Time")]
sub[sub$ID==hid[i], c("ID", "Check_Date", "Check_Time", "Hours")]
sub[sub$ID==hid[i], ]
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"ph", "pH", 
"start.date", "Start_Date", 
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Sub2$Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
graphics.off()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"ph", "pH", 
"start.date", "Start_Date", 
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main)
head(sub)
### determine what concentration and pH values to use
replaceval <- function(id, best1, best2, best3) {
# start with the line-by-line value
usethis <- best1
# but, when an ID has ANY missing values
idnoconc <- sort(unique(id[is.na(best1)]))
# use the target value, instead
usethis[id %in% idnoconc] <- best2[id %in% idnoconc]
# if the target value was also missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(best2)]))
both <- intersect(idnoconc, idnotarg)
usethis[id %in% both] <- best3[id %in% both]
usethis
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), mean, na.rm=TRUE))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, concentration_t, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_t, pH_Target, pH_mean))
# wacky hours
hid <- unique(sub$ID[sub$Hours<0.1])
i <- 1
main[main$ID==hid[i], c("ID", "Start_Date", "Start_Time")]
sub[sub$ID==hid[i], c("ID", "Check_Date", "Check_Time", "Hours")]
hid
# wacky hours
hid <- unique(sub$ID[sub$Hours<0])
i <- 1
main[main$ID==hid[i], c("ID", "Start_Date", "Start_Time")]
sub[sub$ID==hid[i], c("ID", "Check_Date", "Check_Time", "Hours")]
hid
# wacky hours
hid <- unique(sub$ID[sub$Hours<0])
lapply(hid, function(id) {
print(main[main$ID==hid[i], c("ID", "Start_Date", "Start_Time")])
print(sub[sub$ID==hid[i], c("ID", "Check_Date", "Check_Time", "Hours")])
})
# wacky hours
hid <- unique(sub$ID[sub$Hours<0])
lapply(hid, function(id) {
print(main[main$ID==id, c("ID", "Start_Date", "Start_Time")])
print(sub[sub$ID==id, c("ID", "Check_Date", "Check_Time", "Hours")])
})
# wacky hours
hid <- unique(sub$ID[sub$Hours<0])
# lapply(hid, function(id) {
# print(main[main$ID==id, c("ID", "Start_Date", "Start_Time")])
# print(sub[sub$ID==id, c("ID", "Check_Date", "Check_Time", "Hours")])
# })
sub2 <- sub[sub$Hours>0, ]
main2 <- main[main$ID %in% unique(sub2$ID), ]
dim(sub)
dim(sub2)
dim(main)
dim(main2)
summary(sub2)
mytable(sub$Test_Dead)
mytable(sub2$Test_Dead, main2$Folder[match(sub2$ID, main2$ID)])
summary(main2)
mytable(main2$Folder)
mytable(all.main$Folder)
mytable(all.main$Folder# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main)
head(sub)
### determine what concentration and pH values to use
replaceval <- function(id, best1, best2, best3) {
# start with the line-by-line value
usethis <- best1
# but, when an ID has ANY missing values
idnoconc <- sort(unique(id[is.na(best1)]))
# use the target value, instead
usethis[id %in% idnoconc] <- best2[id %in% idnoconc]
# if the target value was also missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(best2)]))
both <- intersect(idnoconc, idnotarg)
usethis[id %in% both] <- best3[id %in% both]
usethis
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), mean, na.rm=TRUE))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, concentration_t, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_t, pH_Target, pH_mean))
### further subset the data to include only those test with reasonable hours
# wacky hours
hid <- unique(sub$ID[sub$Hours<0])
# lapply(hid, function(id) {
# print(main[main$ID==id, c("ID", "Start_Date", "Start_Time")])
# print(sub[sub$ID==id, c("ID", "Check_Date", "Check_Time", "Hours")])
# })
sub2 <- sub[sub$Hours>0, ]
main2 <- main[main$ID %in% unique(sub2$ID), ]
### convert "new" dead to cumulative dead
sub2 <- with(sub2, sub2[order(ID, Hours
mytable(sub2$Test_Dead, main2$Folder[match(sub2$ID, main2$ID)])
mytable(sub2$Test_Dead, main2$Folder[match(sub2$ID, main2$ID)])
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main)
head(sub)
### determine what concentration and pH values to use
replaceval <- function(id, best1, best2, best3) {
# start with the line-by-line value
usethis <- best1
# but, when an ID has ANY missing values
idnoconc <- sort(unique(id[is.na(best1)]))
# use the target value, instead
usethis[id %in% idnoconc] <- best2[id %in% idnoconc]
# if the target value was also missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(best2)]))
both <- intersect(idnoconc, idnotarg)
usethis[id %in% both] <- best3[id %in% both]
usethis
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), mean, na.rm=TRUE))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, concentration_t, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_t, pH_Target, pH_mean))
### further subset the data to include only those test with reasonable hours
# wacky hours
hid <- unique(sub$ID[sub$Hours<0])
# lapply(hid, function(id) {
# print(main[main$ID==id, c("ID", "Start_Date", "Start_Time")])
# print(sub[sub$ID==id, c("ID", "Check_Date", "Check_Time", "Hours")])
# })
sub2 <- sub[sub$Hours>0, ]
main2 <- main[main$ID %in% unique(sub2$ID), ]
### convert "new" dead to cumulative dead
mytable(sub2$Test_Dead, main2$Folder[match(sub2$ID, main2$ID)])
mytable(all.main$Folder)
mytable(main$Folder)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
# sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]# pH
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main)
head(sub)
mytable(main$Folder)
graphics.off()
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
# sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]# pH
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main, 3)
head(sub, 3)
mytable(main$Folder)
### determine what concentration and pH values to use
replaceval <- function(id, best1, best2, best3) {
# start with the line-by-line value
usethis <- best1
# but, when an ID has ANY missing values
idnoconc <- sort(unique(id[is.na(best1)]))
# use the target value, instead
usethis[id %in% idnoconc] <- best2[id %in% idnoconc]
# if the target value was also missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(best2)]))
both <- intersect(idnoconc, idnotarg)
usethis[id %in% both] <- best3[id %in% both]
usethis
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), mean, na.rm=TRUE))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, concentration_t, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_t, pH_Target, pH_mean))
### further subset the data to include only those test with reasonable hours
# wacky hours
hid <- unique(sub$ID[sub$Hours<0])
# lapply(hid, function(id) {
# print(main[main$ID==id, c("ID", "Start_Date", "Start_Time")])
# print(sub[sub$ID==id, c("ID", "Check_Date", "Check_Time", "Hours")])
# })
sub2 <- sub[sub$Hours>0, ]
main2 <- main[main$ID %in% unique(sub2$ID), ]
### convert "new" dead to cumulative dead
mytable(main2$Folder)
mytable(sub2$Test_Dead, main2$Folder[match(sub2$ID, main2$ID)])
head(main2)
with(main2, tapply(ID, Folder, range))
sub2[sub2$ID==15167, ]
sub2[sub2$ID==15167, ]
# C:\JVA\Lamprey\ChemControl\Resistance\Boogaard\ReadBoogaard.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/"
myfiles <- c("1989-1990 combined tox data TFM sea lamprey.xls", 
"1997 1998 combined tox data TFM sea lamprey.xls", 
"2001-2003 combined tox data TFM sea lamprey.xls", 
"2009 combined tox data TFM sea lamprey.xls", 
"On-site tests-Ludington-- Final JVAmod.xls", 
"On-site tests-Canada JVAmod.xls")
startr <- c(6, 6, 6, 5, 6, 6, 1)
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
dat <- readWorksheet(wb, sheet=getSheets(wb)[1], startRow=startr[i])
names(dat) <- jvanames(names(dat))
dat$Folder <- "Boogaard"
dat$File <- myfiles[i]
dat$Row <- 1:dim(dat)[1]
datlist[[i]] <- dat
}
dat <- do.call(rbind.fill, datlist)
head(dat)
# remove rows with all missing data
dat1 <- dat[!is.na(dat$total), ]
# remove columns with all missing data
dat1 <- dat1[, c("date", "tank", "ph.nom", "ph.ave", "alk.nom", "alk.ave", "tfm", "dead", "total", "x.nic.nom", "x.nic.ave", "location", "note", 
"Folder", "File")]
# convert to numeric
dat1$alk.nom <- as.numeric(dat1$alk.nom)
dat1$alk.ave <- as.numeric(dat1$alk.ave)
# fill in zeroes for missing niclosamides
dat1$x.nic.nom[is.na(dat1$x.nic.nom)] <- 0
dat1$x.nic.ave[is.na(dat1$x.nic.ave)] <- 0
# look at notes
dat1[!is.na(dat1$note), ]
dat1[!is.na(dat1$location) & dat1$location=="Nunns Creek", ]
# eliminate two brown trout records
dat1[!is.na(dat1$location) & dat1$location=="Nunns Creek" & dat1$tank %in% 16:20, ]
dat1 <- dat1[!(!is.na(dat1$location) & dat1$location=="Nunns Creek" & dat1$tank %in% 16:20), ]
boogdat <- dat1
head(boogdat)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note                                          file
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 4 1989-02-20    4    6.5   6.54      30      27 0.26   19    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 5 1989-02-20    5    6.5   6.54      30      27 0.20   11    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 6 1989-02-20    6    6.5   6.54      30      27 0.17    2    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
head(main, 3)
head(sub, 3)
d <- tapply(Test_Dead, list(ID, conc_use), sum, na.rm=TRUE)
n <- tapply(Number_Tested, list(ID, conc_use), sum, na.rm=TRUE)
h <- tapply(Hours, list(ID, conc_use), max, na.rm=TRUE)
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
# sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]# pH
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main, 3)
head(sub, 3)
mytable(main$Folder)
### determine what concentration and pH values to use
replaceval <- function(id, best1, best2, best3) {
# start with the line-by-line value
usethis <- best1
# but, when an ID has ANY missing values
idnoconc <- sort(unique(id[is.na(best1)]))
# use the target value, instead
usethis[id %in% idnoconc] <- best2[id %in% idnoconc]
# if the target value was also missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(best2)]))
both <- intersect(idnoconc, idnotarg)
usethis[id %in% both] <- best3[id %in% both]
usethis
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), mean, na.rm=TRUE))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, concentration_t, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_t, pH_Target, pH_mean))
d <- with(sub, tapply(Test_Dead, list(ID, conc_use), sum, na.rm=TRUE))
n <- with(sub, tapply(Number_Tested, list(ID, conc_use), sum, na.rm=TRUE))
h <- with(sub, tapply(Hours, list(ID, conc_use), max, na.rm=TRUE))
dim(d)
head(d)
head
d <- with(sub, tapply(Test_Dead, paste(ID, conc_use), sum, na.rm=TRUE))
n <- with(sub, tapply(Number_Tested, paste(ID, conc_use), sum, na.rm=TRUE))
h <- with(sub, tapply(Hours, paste(ID, conc_use), max, na.rm=TRUE))
dim(d)
dim(n)
d[1:100]
data.frame(d, n, h)
c <- with(sub, tapply(conc_use, paste(ID), sd, na.rm=TRUE))
plot(c)
c[c>4]
c[!is.na(c) & c>4]
names(c[!is.na(c) & c>4])
main[main$ID %in% names(c[!is.na(c) & c>4]), ]
names(c[!is.na(c) & c>4])
main[main$ID==12763, ]
sub[sub$ID==12763, ]
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(conc_use, paste(ID), sdnozero, na.rm=TRUE))
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(conc_use, paste(ID), sdnozero))
plot(c)
names(c[!is.na(c) & c>4])
main[main$ID==12763, ]
sub[sub$ID==12763, ]
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(conc_use, ID, sdnozero))
names(c[!is.na(c) & c>4])
main[main$ID==12763, ]
sub[sub$ID==12763, ]
main[main$ID==15180, ]
sub[sub$ID==15180, ]
locator()
McGarrydat
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
cleanup()
q()
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
head(McGarrydat)
McGarrydat
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
McGarrydat
search()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
# sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]# pH
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main, 3)
head(sub, 3)
mytable(main$Folder)
### determine what concentration and pH values to use
replaceval <- function(id, best1, best2, best3) {
# start with the line-by-line value
usethis <- best1
# but, when an ID has ANY missing values
idnoconc <- sort(unique(id[is.na(best1)]))
# use the target value, instead
usethis[id %in% idnoconc] <- best2[id %in% idnoconc]
# if the target value was also missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(best2)]))
both <- intersect(idnoconc, idnotarg)
usethis[id %in% both] <- best3[id %in% both]
usethis
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), mean, na.rm=TRUE))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, concentration_t, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_t, pH_Target, pH_mean))
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(conc_use, ID, sdnozero))
names(c[!is.na(c) & c>4])
main[main$ID==15180, ]
sub[sub$ID==15180, ]
plot(c)
names(c[!is.na(c) & c>2])
main[main$ID==13970, ]
sub[sub$ID==13970, ]
main[main$ID==13970, ]
sub[sub$ID==13970, ]
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(concentration_t, ID, sdnozero))
plot(c)
c
summary(c)
plot(c)
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(concentration_t, ID, sdnozero))
names(c[!is.na(c) & c>0.4])
main[main$ID==13359, ]
sub[sub$ID==13359, ]
main[main$ID==13359, ]
sub[sub$ID==13359, ]
names(c[!is.na(c) & c>0.4])
main[main$ID==13365, ]
sub[sub$ID==13365, ]
main[main$ID==13823, ]
sub[sub$ID==13823, ]
main[main$ID==13970, ]
sub[sub$ID==13970, ]
main[main$ID==14020, ]
sub[sub$ID==14020, ]
cleanup()
q()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
cleanup()
graphics.off()
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
hist(all.sub$Hours)
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
# sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]# pH
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main, 3)
head(sub, 3)
mytable(main$Folder)
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(concentration_t, ID, sdnozero))
names(c[!is.na(c) & c>0.4])
# "13359" "13365" "13823" "13970" "14020"
main[main$ID==14020, ]
sub[sub$ID==14020, ]
d <- with(sub, tapply(Test_Dead, paste(ID, conc_use), sum, na.rm=TRUE))
n <- with(sub, tapply(Number_Tested, paste(ID, conc_use), sum, na.rm=TRUE))
h <- with(sub, tapply(Hours, paste(ID, conc_use), max, na.rm=TRUE))
d
look <- with(sub, table(ID, conc_use))
look
apply(look>0, 1, sum)
mytable(apply(look>0, 1, sum))
d <- with(sub, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
look <- data.frame(d, n, h)
head(look)
dim(look)
hist(h)
summary(h)
table(h)
table(round(h))
hist(h[h>0 & h<30])
stemleaf(h[h>0 & h<30])
leaf(h[h>0 & h<30])
stem(h[h>0 & h<30])
stem(round(h)[h>0 & h<30])
plot(sort(h[h>0 & h<30]))
abline(h=c(9, 12, 24))
plot(sort(sub$Hours[sub$Hours>0 & sub$Hours<30]))
abline(h=c(9, 12, 24))
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
# sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]# pH
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main, 3)
head(sub, 3)
mytable(main$Folder)
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(concentration_t, ID, sdnozero))
names(c[!is.na(c) & c>0.4])
# "13359" "13365" "13823" "13970" "14020"
main[main$ID==14020, ]
sub[sub$ID==14020, ]
# only one concentration per ID ... that's good
look <- with(sub, table(ID, conc_use))
mytable(apply(look>0, 1, sum))
### further subset the data to include only those test with reasonable hours
# wacky hours
# hid <- unique(sub$ID[sub$Hours<0])
# lapply(hid, function(id) {
# print(main[main$ID==id, c("ID", "Start_Date", "Start_Time")])
# print(sub[sub$ID==id, c("ID", "Check_Date", "Check_Time", "Hours")])
# })
sub2 <- sub[sub$Hours>0 & sub$Hours<30, ]
main2 <- main[main$ID %in% unique(sub2$ID), ]
mytable(main2$Folder)
### convert "new" dead to cumulative dead
### total up the results for each test (ID)
d <- with(sub2, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub2, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub2, tapply(Hours, ID, max, na.rm=TRUE))
look <- data.frame(d, n, h)
head(look)
plot(sort(h[h>0 & h<30]))
abline(h=c(9, 12, 24))
plot(sort(h))
plot(sort(h))
abline(h=c(9, 12, 24))
mytable(round(h))
sort(mytable(round(h)))
head(sub)
class(sub$Check_Date)
head(main)
class(main$Start_Date)
library(lubridate)
main$Year <- year(main$Start_Date)
head(main)
sub$Year <- main$Year[match(sub$ID, main$ID)]
head(sub)
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
library(lubridate)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
main$Year <- year(main$Start_Date)
# sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]# pH
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
sub$Year <- main$Year[match(sub$ID, main$ID)]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main, 3)
head(sub, 3)
mytable(main$Folder)
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(concentration_t, ID, sdnozero))
names(c[!is.na(c) & c>0.4])
# "13359" "13365" "13823" "13970" "14020"
main[main$ID==14020, ]
sub[sub$ID==14020, ]
# only one concentration per ID ... that's good
look <- with(sub, table(ID, conc_use))
mytable(apply(look>0, 1, sum))
look <- with(sub, table(ID, conc_use))
mytable(apply(look>0, 1, sum))
### further subset the data to include only those test with reasonable hours
# wacky hours
# hid <- unique(sub$ID[sub$Hours<0])
# lapply(hid, function(id) {
# print(main[main$ID==id, c("ID", "Start_Date", "Start_Time")])
# print(sub[sub$ID==id, c("ID", "Check_Date", "Check_Time", "Hours")])
# })
sub2 <- sub[sub$Hours>0 & sub$Hours<30, ]
main2 <- main[main$ID %in% unique(sub2$ID), ]
mytable(main2$Folder)
### total up the results for each test (ID)
d <- with(sub2, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub2, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub2, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(sub2, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(sub2, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub2, tapply(Year, ID, mean, na.rm=TRUE))
# look at comments
look <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
head(look)
with(look, table(round(hours), year))
dim(with(look, table(round(hours), year)))
dim(with(look, table(round(hours), year)))
with(look, table(round(hours), year))
with(look, table(year, round(hours)))
plot(with(look, table(year, round(hours))))
with(look, table(round(hours), year))
with(look, table(round(hours), round(year, -1)))
?round
?round
search()
ls(5)
stringin("near", ls(5))
with(look, table(2*round(hours/2), 5*round(year/5)))
with(look, table(2*round(hours/2), 5*round(year/5)))[, 7]
sort(with(look, table(2*round(hours/2), 5*round(year/5)))[, 7])
look2 <- look[2*round(look$hours/2)==24, ]
dim(look2)
head(look2)
with(look2, plot(conc, ndead/ntest))
with(look2, plot(jitter(conc), jitter(ndead/ntest)))
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
library(LW1949)
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
dim(mydat)
dim(look2)
head(mydat)
head(look2)
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
##### need to "fix" the all.sub data
##### need to bring in the other raw data (Boogaard only? or is there more?)
##### need to bring in other summary data ???
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
# ssel <- subdex(all.sub, (pH_t>0 | pH_Target>0) & Species==2)# pH
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
main$Year <- year(main$Start_Date)
# sub <- all.sub[subdex(all.sub, ID %in% ids & (pH_t>0 | pH_Target>0) & Species==2), ]# pH
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
sub$Year <- main$Year[match(sub$ID, main$ID)]
dim(all.main)
dim(main)
dim(all.sub)
dim(sub)
head(main, 3)
head(sub, 3)
mytable(main$Folder)
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
sdnozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
c <- with(sub, tapply(concentration_t, ID, sdnozero))
names(c[!is.na(c) & c>0.4])
# "13359" "13365" "13823" "13970" "14020"
main[main$ID==14020, ]
sub[sub$ID==14020, ]
# only one concentration per ID ... that's good
look <- with(sub, table(ID, conc_use))
mytable(apply(look>0, 1, sum))
look <- with(sub, table(ID, conc_use))
mytable(apply(look>0, 1, sum))
### further subset the data to include only those test with reasonable hours and those with concentrations greater than 0
# wacky hours
# hid <- unique(sub$ID[sub$Hours<0])
# lapply(hid, function(id) {
# print(main[main$ID==id, c("ID", "Start_Date", "Start_Time")])
# print(sub[sub$ID==id, c("ID", "Check_Date", "Check_Time", "Hours")])
# })
sub2 <- sub[sub$Hours>0 & sub$Hours<30 & sub$conc_use>0, ]
main2 <- main[main$ID %in% unique(sub2$ID), ]
mytable(main2$Folder)
### total up the results for each test (ID)
d <- with(sub2, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub2, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub2, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(sub2, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(sub2, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub2, tapply(Year, ID, mean, na.rm=TRUE))
# look at comments
look <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
head(look)
with(look, table(2*round(hours/2), 5*round(year/5)))
with(look, table(2*round(hours/2), 5*round(year/5)))[, 7]
look2 <- look[2*round(look$hours/2)==24, ]
with(look2, plot(jitter(conc), jitter(ndead/ntest)))
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
with(look, table(2*round(hours/2), 5*round(year/5)))[, 4]
rev(sort(with(look, table(2*round(hours/2), 5*round(year/5)))[, 4]))
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
head(look2)
head(mydat)
?fitprobit
fitprobit
pfit <- glm(cbind(ndead, ntest - ndead) ~ log10(conc), family=binomial(link=probit), data=look2)
pfit <- glm(cbind(ndead, ntest - ndead) ~ log10(conc), family=binomial(link=probit), data=look2)
?dataprep
look2 <- look[2*round(look$hours/2)==24, ]
with(look2, plot(jitter(log10(conc)), jitter(probit(ndead/ntest))))
pfit
points(log10(conc), pfit$fitted, col="red", pch=16)
with(look2, points(log10(conc), pfit$fitted, col="red", pch=16))
pfit$fitted
summary(pfit$fitted)
head(mydat)
?keeponly
keeponly(100*look$dead/look$ntest)
head(look2)
keeponly(100*look2$ndead/look2$ntest)
table(keeponly(100*look2$ndead/look2$ntest))
mytable(keeponly(100*look2$ndead/look2$ntest))
100*look2$ndead/look2$ntest)
100*look2$ndead/look2$ntest
mytable(100*look2$ndead/look2$ntest)
a <- c(3, 6, 1, 9)
a
order(a)
ord <- order(a)
a[ord]
orig <- 1:4
orig[ord]
a[ord][order(ord)]
keeponly <- function(x, extremes=c(0, 100), nconsec=2) {
ord <- order(x)
orderedx <- x[ord]
hi <- orderedx==extremes[2]
selnohi <- cumsum(hi) <= nconsec
lo <- rev(orderedx==extremes[1])
selnolo <- rev(cumsum(lo) <= nconsec)
ko <- selnolo & selnohi
ko[order(ord)]
}
vec <- c(0, 0, 0, 4, 4, 4, 100, 100, 100, 100)
vec[keeponly(vec)]
sample(vec)
vec <- sample(vec)
vec
vec[keeponly(vec)]
dput(vec)
vec[keeponly(vec)]
#' Eliminate Consecutive Extreme Values
#'
#' Generate the index for eliminating values beyond a given maximum number of consecutive extremes allowed.
#' @param x A numeric vector.
#' @param extremes A numeric vector of length two, boundary limits of numeric vector, default c(0, 100).
#' @param nconsecAn integer scalar, the maximum number of consecutive extreme values allowed, default 2.
#' @return A logical vector for selecting all elements of \code{orderedx} without exceeding 
#'\code{nconsec} consecutive extreme values.
#' @export
#' @examples
#' vec <- c(0, 0, 0, 4, 4, 4, 100, 100, 100, 100)
#' vec[keeponly(vec)]
#' # the original vector need not be ordered
#' vec <- c(100, 4, 100, 4, 0, 100, 0, 4, 0, 100)
#' vec[keeponly(vec)]
keeponly <- function(x, extremes=c(0, 100), nconsec=2) {
ord <- order(x)
orderedx <- x[ord]
hi <- orderedx==extremes[2]
selnohi <- cumsum(hi) <= nconsec
lo <- rev(orderedx==extremes[1])
selnolo <- rev(cumsum(lo) <= nconsec)
ko <- selnolo & selnohi
ko[order(ord)]
}
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
head(look2)
head(mydat)
dose=conc
ntot=ntest
nfx=ndead
dose=look2$conc
ntot=look2$ntest
nfx=look2$ndead
# create a data frame
df <- data.frame(dose=dose, ntot=ntot, nfx=nfx)
# assign row number
df$rec <- 1:dim(df)[1]
# calculate proportion affected
df$pfx <- df$nfx/df$ntot
# order data frame
df <- df[order(df$dose, df$pfx), ]
# transform variables
df$log10dose <- log10(df$dose)
df$bitpfx <- probit(df$pfx)
# define three effect categories, 0 for none affected, 100 for all affected, and 50 for other proportions affected
df$fxcateg <- fxcat(df)
# define records to keep for Litchfield Wilcoxon method
# get rid of consecutive 0% and 100%s
# A 1. Don't list > 2 consecutive 100% effects at the upper end or > 2 consecutive 0% effects at the lower end.
head(df)
df$LWkeep <- keeponly(100*df$pfx)
head(df)
df$LWkeep[is.na(df$dose) | is.na(df$pfx)] <- FALSE
head(df)
df$LWkeep[df$dose == 0] <- FALSE
head(df)
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
head(mydat)
rm(mydat)
mydat
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
head(mydat0
head(mydat)
find("keeponly")
dataprep <- function(dose, ntot, nfx) {
# create a data frame
df <- data.frame(dose=dose, ntot=ntot, nfx=nfx)
# assign row number
df$rec <- 1:dim(df)[1]
# calculate proportion affected
df$pfx <- df$nfx/df$ntot
# order data frame
df <- df[order(df$dose, df$pfx), ]
# transform variables
df$log10dose <- log10(df$dose)
df$bitpfx <- probit(df$pfx)
# define three effect categories, 0 for none affected, 100 for all affected, and 50 for other proportions affected
df$fxcateg <- fxcat(df)
# define records to keep for Litchfield Wilcoxon method
# get rid of consecutive 0% and 100%s
# A 1. Don't list > 2 consecutive 100% effects at the upper end or > 2 consecutive 0% effects at the lower end.
df$LWkeep <- keeponly(100*df$pfx)
# get rid of any missing doses or effects
df$LWkeep[is.na(df$dose) | is.na(df$pfx)] <- FALSE
# get rid of any zero doses (controls)
df$LWkeep[df$dose == 0] <- FALSE
df
}
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
head(mydat)
summary(mydat)
dim(look2)
dim(mydat)
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
both <- cbind(mydat, look2[mydat$rec, ])
head(both)
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
both <- cbind(mydat, look2[mydat$rec, ])
pfit <- fitprobit(both)
mydat <- with(look2, dataprep(dose=conc, ntot=ntest, nfx=ndead))
both <- cbind(mydat, look2[mydat$rec, ])
pfit <- fitprobit(both)
plotDE(both)
abline(pfit$coef, lty=2)
cleanup()
q()
# Load required libraries:
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
# Visualise the data (ignored for now...):
# plot(datgr)
# Declare growth functions:
LVB = function(x, t0, Lmax, K) {
y = Lmax*(1-exp(-K*(x-t0)))
y
}
# Fit a LVB model by NLME. 
# If the model does not converge, try changing starting values:
LVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr, fixed= t0 + Lmax + K ~ 1, random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, Lmax=46, K=0.18)))
# Display results:
summary(LVB.nlme)
intervals(LVB.nlme)
anova(LVB.nlme)
head(coef(LVB.nlme))
# These two plots are ignored for now...
# plot(LVB.nlme)
# plot(augPred(LVB.nlme, level=0:1))
apply(coef(LVB.nlme), 2, median)
# Compare LVB growth models between two (or more) groups:
LVB1.nlme = update(LVB.nlme, fixed= t0 + Lmax + K ~ Sex, 
start=list(fixed=c(-0.41, 0, 0, 46, 0, 0, 0.18, 0, 0)))
# C:\JVA\Consult\Hansen\vonBgrowth\Musky_growth3 - JVA.R
# Load required libraries:
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
# Visualise the data (ignored for now...):
# plot(datgr)
# Declare growth functions:
LVB = function(x, t0, Lmax, K) {
y = Lmax*(1-exp(-K*(x-t0)))
y
}
# Fit a LVB model by NLME. 
# If the model does not converge, try changing starting values:
LVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr, fixed= t0 + Lmax + K ~ 1, random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, Lmax=46, K=0.18)))
# Display results:
summary(LVB.nlme)
intervals(LVB.nlme)
anova(LVB.nlme)
head(coef(LVB.nlme))
# These two plots are ignored for now...
# plot(LVB.nlme)
# plot(augPred(LVB.nlme, level=0:1))
apply(coef(LVB.nlme), 2, median)
?coef.lme
names(summary(LVB.nlme))
summary(LVB.nlme)$contrasts
summary(LVB.nlme)$coef
summary(LVB.nlme)$coef$fixed
# Load required libraries
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr = groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MyData.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(mm)"))
datgr$Morph <- as.factor(datgr$Morph)
# datgr = groupedData(L~Age|id/Morph, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MyData.txt", header=TRUE, sep="\t"), 
# labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(mm)"))
# visualise the data (ignored for now):
# plot(datgr)
# Declare growth function:
LVB = function(x, t0, Lmax, K) {
y = Lmax*(1-exp(-K*(x-t0)))
y
}
# Fit a LVB model by NLME:
# If the model does not converge, try changing starting values (bold):
LVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr, fixed= t0 + Lmax + K ~ 1, random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-1.0, Lmax=550, K=0.1)))
# Display results:
summary(LVB.nlme)
intervals(LVB.nlme)
anova(LVB.nlme)
summary(LVB.nlme)$coef$fixed
# Compare LVB growth models between two (or more) groups:
LVB1.nlme = update(LVB.nlme, fixed= t0 + Lmax + K ~ Morph, 
start=list(fixed=c(-1, 0, 0, 550, 0, 0, 0.1, 0, 0)))
summary(LVB1.nlme)$coef$fixed
# Load required libraries:
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
# Visualise the data (ignored for now...):
# plot(datgr)
# Declare growth functions:
LVB = function(x, t0, Lmax, K) {
y = Lmax*(1-exp(-K*(x-t0)))
y
}
# Fit a LVB model by NLME. 
# If the model does not converge, try changing starting values:
LVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr, fixed= t0 + Lmax + K ~ 1, random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, Lmax=46, K=0.18)))
# Display results:
summary(LVB.nlme)
intervals(LVB.nlme)
anova(LVB.nlme)
summary(LVB.nlme)$coef$fixed
head(coef(LVB.nlme))
# These two plots are ignored for now...
# plot(LVB.nlme)
# plot(augPred(LVB.nlme, level=0:1))
summary(LVB1.nlme)$coef$fixed
summary(LVB1.nlme)
names(summary(LVB1.nlme))
summary(LVB1.nlme)$tTable
summary(LVB.nlme)
LVBa.nlme = update(LVB.nlme, fixed= Lmax ~ Sex, 
start=list(fixed=c(-0.44, 46, 0, 0, 0.18)))
LVBa.nlme = update(LVB.nlme, fixed= list(t0 ~ 1, Lmax ~ Sex, K ~ 1),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18)))
LVBb.nlme = update(LVB.nlme, fixed= list(t0 ~ 1, Lmax ~ Sex, K ~ Sex),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18)))
LVBb.nlme = update(LVB.nlme, fixed= list(t0 ~ 1, Lmax ~ Sex, K ~ Sex),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18, 0, 0)))
?nlme
anova(LVB.nlme)
anova(LVBa.nlme)
plot(datgr)
plot(L ~ Age | Sex, datgr)
plot(L ~ Age | Sex, data=datgr)
head(datgr)
xyplot(L ~ Age | Sex, data=datgr)
# Then I tried fitting a different Lmax and K for the different sexes ... no convergence after the default 50 iterations
LVBb.nlme = update(LVB.nlme, fixed= list(t0 ~ 1, Lmax ~ Sex, K ~ Sex),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18, 0, 0)), control=nlmeControl(maxIter=1000))
# test for significant effect of Sex
anova(LVB.nlme, LVBa.nlme)
# Import the data into R under the object name datgr:
datgr = groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MyData.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(mm)"))
datgr$Morph <- as.factor(datgr$Morph)
# visualise the data (ignored for now):
# plot(datgr)
xyplot(L ~ Age | Morph, datgr)
xyplot(L ~ Age | Sex, datgr)
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
# Visualise the data (ignored for now...):
# plot(datgr)
xyplot(L ~ Age | Sex, datgr)
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
datgr2 <- datgr[datgr$Sex!="U", ]
xyplot(L ~ Age | Sex, datgr)
xyplot(L ~ Age | Sex, datgr2)
mfLVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr2, fixed= list(t0 ~ 1, Lmax ~ 1, K ~ 1), random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, Lmax=46, K=0.18)))
mfLVBa.nlme = update(LVB.nlme, fixed= list(t0 ~ 1, Lmax ~ Sex, K ~ 1),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18)))
mfLVBb.nlme = update(LVB.nlme, fixed= list(t0 ~ 1, Lmax ~ Sex, K ~ Sex),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18, 0, 0)), control=nlmeControl(maxIter=100))
mfLVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr2, fixed= list(t0 ~ 1, Lmax ~ 1, K ~ 1), random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, Lmax=46, K=0.18)))
mfLVBa.nlme = update(LVB.nlme, fixed= list(t0 ~ Sex, Lmax ~ 1, K ~ 1),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18)))
mfLVBb.nlme = update(LVB.nlme, fixed= list(t0 ~ 1, Lmax ~ Sex, K ~ 1),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18)))
mfLVBc.nlme = update(LVB.nlme, fixed= list(t0 ~ 1, Lmax ~ 1, K ~ Sex),
start=list(fixed=c(-0.44, 46, 0, 0, 0.18)))
anova(LVB.nlme, LVBa.nlme, LVBb.nlme, LVBc.nlme)
# I started by just letting each coef (one at a time) vary by sex ... this ran fine
LVBa.nlme = update(LVB.nlme, fixed= list(t0 ~ Sex, Lmax ~ 1,   K ~ 1),  start=list(fixed=c(-0.44, 0, 0, 46,       0.18)))
LVBb.nlme = update(LVB.nlme, fixed= list(t0 ~ 1,   Lmax ~ Sex, K ~ 1),  start=list(fixed=c(-0.44,       46, 0, 0, 0.18)))
LVBc.nlme = update(LVB.nlme, fixed= list(t0 ~ 1,   Lmax ~ 1,   K ~ Sex), start=list(fixed=c(-0.44,       46,       0.18, 0, 0)))
anova(LVB.nlme, LVBa.nlme, LVBb.nlme, LVBc.nlme)
LVBbc.nlme = update(LVB.nlme, fixed= list(t0 ~ 1,   Lmax ~ Sex, K ~ Sex),  start=list(fixed=c(-0.44,       46, 0, 0, 0.18, 0, 0)))
q()
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
library(lubridate)
library(LW1949)
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- main$Year[match(all.sub$ID, all.main$ID)]
decade <- function(y) {
10*floor(y/10)
}
a <- with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(year, boogdat$x.nic.nom==0))
a <- with(all.main, mytable(decade(Year), paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(decade(year), boogdat$x.nic.nom==0))
a
b
yrz <- as.numeric(c(dimnames(b)[[1]], dimnames(a)[[1]]))
yrz <- seq(min(yrz), max(yrz), 10)
a <- a[match(yrz, dimnames(a)[[1]]), ]
b <- b[match(yrz, dimnames(b)[[1]]), ]
a[is.na(a)] <- 0
b[is.na(b)] <- 0
a[, 1] <- a[, 1] + b[, 1]
a[, 3] <- a[, 3] + b[, 2]
dimnames(a)[[1]] <- yrz
a
dim(a)
head(all.main)
head(all.main)
head(all.sub)
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
head(sub)
head(meanz)
### total up the results for each test (ID)
h <- with(sub2, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub2, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub2, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(idat)
### total up the results for each test (ID)
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(dat)
head(sub)
library(lubridate)
library(LW1949)
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- main$Year[match(all.sub$ID, all.main$ID)]
head(all.sub)
decade <- function(y) {
10*floor(y/10)
}
a <- with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(year, boogdat$x.nic.nom==0))
a <- with(all.main, mytable(decade(Year), paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(decade(year), boogdat$x.nic.nom==0))
a
b
yrz <- as.numeric(c(dimnames(b)[[1]], dimnames(a)[[1]]))
yrz <- seq(min(yrz), max(yrz), 10)
a <- a[match(yrz, dimnames(a)[[1]]), ]
b <- b[match(yrz, dimnames(b)[[1]]), ]
a[is.na(a)] <- 0
b[is.na(b)] <- 0
a[, 1] <- a[, 1] + b[, 1]
a[, 3] <- a[, 3] + b[, 2]
dimnames(a)[[1]] <- yrz
a
a[, 4:1]
format(a[, 4:1], big.mark=",")
### focus on Static, TFM only to start
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
head(sub)
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
head(sub)
### total up the results for each test (ID)
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(dat)
plotdf(dat)
.SavedPlots <- NULL
mytable(round(h))
mytable(round(p))
### total up the results for each test (ID)
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(dat)
dat2 <- dat2[subdex(dat2, hours>0 & hours<100), ]
dat2 <- dat2[!subdex(dat2, ph<1 | ph>14), ]
summary(dat)
summary(dat2)
### total up the results for each test (ID)
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(dat)
dat2 <- dat[subdex(dat, hours>0 & hours<100), ]
dat2 <- dat2[!subdex(dat2, ph<1 | ph>14), ]
summary(dat)
summary(dat2)
a <- with(dat2, mytable(decade(year), paste(is.na(ph), cut(hours, ceq(0, 80, 8))) ) )
a <- with(dat2, mytable(decade(year), paste(is.na(ph), cut(hours, seq(0, 80, 8))) ) )
dim(a)
a
mytable(dat2$year)
summary(y)
summary(sub)
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- main$Year[match(all.sub$ID, all.main$ID)]
m <- match(all.sub$ID, all.main$ID)
summary(m)
?set
??set
?intersect
setdiff(all.sub$ID, all.main$ID)
(x <- c(sort(sample(1:20, 9)), NA))
(y <- c(sort(sample(3:23, 7)), NA))
union(x, y)
intersect(x, y)
setdiff(x, y)
setdiff(y, x)
setequal(x, y)
x
y
all.main$ID[all.main$ID==15167, ]
all.main[all.main$ID==15167, ]
all.sub[all.sub$ID==15167, ]
cleanup()
search()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
q()
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
look <- all.sub[all.sub$ID %in% setdiff(all.sub$ID, all.main$ID), ]
summary(look)
with(all.main, tapply(ID, Folder, range))
hist(look$ID)
head(McGarrydat)
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
head(McGarrydat)
hist(McGarrdat$ID)
hist(McGarrydat$ID)
graphics.off()
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
head(McGarrydat)
head(McGarrydat, 3)
head(McGarrydat, 3)
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
head(McGarrydat, 3)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date) | !is.na(McGarrydat$concentration_t), 
c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
setdiff(m.sub$ID, m.main$ID)
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date) | !is.na(McGarrydat$concentration_t), 
c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
look <- all.sub[all.sub$ID %in% setdiff(all.sub$ID, all.main$ID), ]
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
graphics.off()
cleanup()
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- main$Year[match(all.sub$ID, all.main$ID)]
m <- match(all.sub$ID, all.main$ID)
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
decade <- function(y) {
10*floor(y/10)
}
with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
head(McGarrydat)
rm(mydir, myfiles, datlist, i, wb, mysheets, sheetlist, j, dat)
McGarrydat
names(McGarrydat)
fill
?fill
# fill in the blanks for most of the columns
x <- lapply(McGarrydat[, 1:24], fill)
x
x <- data.frame(lapply(McGarrydat[, 1:24], fill))
dim(x)
dim(McGarrydat)
x
names(McGarrydat)
dput(names(McGarrydat))
# fill in the blanks for most of the columns
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
x <- data.frame(lapply(McGarrydat[, !sel], fill))
dim(McGarrydat)
dim(x)
# fill in the blanks for most of the columns
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
McGarrydat[, !sel] <- data.frame(lapply(McGarrydat[, !sel], fill))
McGarrydat
# C:\JVA\Lamprey\ChemControl\Resistance\Robertson\ReadRobertson.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/Robertson/"
myfiles <- c("2009_Toxdata.xlsx", "2010_toxdata.xlsx", "2011_toxdata.xlsx", "2013_toxdata.xlsx")
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=3)
names(dat) <- jvanames(names(dat))
dat$Folder <- "Robertson"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
makedate <- function(x) {
sel <- !is.na(x)
x1 <- x[sel]
# replace all punctuation marks with hyphens
x2 <- gsub("[[:punct:]]", "-", x1)
# break up string into three parts
x3 <- strsplit(x2, "-")
# if 3rd string is length 4, move it to 1st
nc3 <- lapply(x3, function(y) 
{
if(nchar(y)[3] > 3) y[c(3, 1, 2)] else y
}
)
# combine three parts again
x[sel] <- sapply(nc3, paste, collapse="-")
as.POSIXlt(x)
}
datlist[[3]]$start.date <- makedate(datlist[[3]]$start.date)
datlist[[3]]$water.chem..date <- makedate(datlist[[3]]$water.chem..date)
datlist[[4]]$start.date <- makedate(datlist[[4]]$start.date)
datlist[[4]]$water.chem..date <- makedate(datlist[[4]]$water.chem..date)
dat <- do.call(rbind.fill, datlist)
Robdat <- dat
Robdat$ID <- cumsum(!is.na(Robdat$start.date))
head(Robdat)
rm(mydir, myfiles, datlist, i, wb, mysheets, sheetlist, j, makedate, dat)
dput(names(Robdat))
# fill in the blanks for most of the columns
leavethese <- c("ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(Robdat) %in% leavethese
x  <- data.frame(lapply(Robdat[, !sel], fill))
dim(Robdat)
dim(x)
x
Robdat[, !sel] <- data.frame(lapply(Robdat[, !sel], fill))
Robdat
# C:\JVA\Lamprey\ChemControl\Resistance\Slaght\ReadSlaght.r
library(plyr)
makedate <- function(x) {
sel <- !is.na(x)
x1 <- x[sel]
# replace all punctuation marks with hyphens
x2 <- gsub("[[:punct:]]", "-", x1)
# break up string into three parts
x3 <- strsplit(x2, "-")
# if 3rd string is length 4, move it to 1st
nc3 <- lapply(x3, function(y) 
{
if(nchar(y)[3] > 3) y[c(3, 1, 2)] else y
}
)
# combine three parts again
x[sel] <- sapply(nc3, paste, collapse="-")
as.POSIXlt(x)
}
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/Slaght/"
myfiles <- "Historical TFM Testing.xlsx"
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j])
names(dat) <- jvanames(names(dat))
dat$Folder <- "Slaght"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
if(class(dat$start.date)[1]=="character") dat$start.date <- makedate(substring(dat$start.date, 1, 10))
if(class(dat$end.date)[1]=="character") dat$end.date <- makedate(substring(dat$start.date, 1, 10))
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
Slaghtdat <- datlist[[1]]
# the cumulative number of dead was recorded only when there was a new death (same for ill)
# so, a series of numbers like 0, 1, 0, 2, 0 represents new dead 0, 1, 0, 1, 0, and true cumulative dead 0, 1, 1, 2, 2
# to make these numbers conform to the number of dead recorded in other data sheets, they will be converted to "new dead"
convert <- function(cumsortof, firstrow) {
# convert so-called cumulative dead/ill numbers to real new dead/ill numbers
cumdead <- cumsortof
# change all zeroes to missings
cumdead[!is.na(cumdead) & cumdead < 0.5] <- NA
# first, if the first row of so-called cumdead is missing, set the number of new dead to zero
cumdead[!is.na(firstrow) & is.na(cumsortof)] <- 0
# then, fill in the remaining missing values with the previous value
cumdead <- fill(cumdead)
# then calculate the new dead as the difference along the cumdead
cumdeadb4 <- c(NA, cumdead[-length(cumdead)])
newdead <- ifelse(!is.na(firstrow), cumdead, cumdead-cumdeadb4)
newdead
}
Slaghtdat$ill <- convert(Slaghtdat$cumulative..ill, Slaghtdat$species)
Slaghtdat$dead <- convert(Slaghtdat$cumulative..dead, Slaghtdat$species)
Slaghtdat$ID <- cumsum(!is.na(Slaghtdat$start.date))
head(Slaghtdat)
rm(mydir, myfiles, datlist, i, wb, mysheets, sheetlist, j, makedate, dat, convert)
dput(names(Slaghtdat))
# fill in the blanks for most of the columns
leavethese <- c("discomfort", "cumulative..ill", "cumulative..dead", "specific.comment..regarding.just.the.corresponding.line.of.data.", "ill", "dead")
sel <- names(Slaghtdat) %in% leavethese
x <- data.frame(lapply(Slaghtdat[, !sel], fill))
dim(Slaghtdat)
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
# assign a new ID every time a new start date or a new concentration is entered
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
head(McGarrydat)
McGarrydat
# fill in the blanks for the columns when a new concentration starts
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
filled <- data.frame(lapply(McGarrydat[, !sel], fill))
newconcrows <- is.na(McGarrydat$Start_Date) & !is.na(McGarrydat$concentration_t)
McGarrydat[newconcrows, !sel] <- filled[newconcrows, ]
names(McGarrydat)
summary(McGarrydat$start.date)
summary(is.na(McGarrydat$start.date))
unique(McGarrydat$start.date)
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
# assign a new ID every time a new start date or a new concentration is entered
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
# fill in the blanks for the columns when a new concentration starts
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
filled <- data.frame(lapply(McGarrydat[, !sel], fill))
newconcrows <- is.na(McGarrydat$start.date) & !is.na(McGarrydat$conc.)
McGarrydat[newconcrows, !sel] <- filled[newconcrows, ]
McGarrydat
cleanup()
search()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub1$Conc_Target <- Main1$Concentration[sm]
Sub1$pH_Target <- Main1$pH[sm]
Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
Sub2$Conc_Target <- Main1$Concentration[sm]
Sub2$pH_Target <- Main1$pH[sm]
Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
look <- all.sub[all.sub$ID %in% setdiff(all.sub$ID, all.main$ID), ]
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- main$Year[match(all.sub$ID, all.main$ID)]
m <- match(all.sub$ID, all.main$ID)
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
decade <- function(y) {
10*floor(y/10)
}
cleanup()
graphics.off()
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- all.main$Year[match(all.sub$ID, all.main$ID)]
with(all.main, tapply(ID, Folder, range))
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
with(all.main, tapply(ID, Folder, range))
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- all.main$Year[match(all.sub$ID, all.main$ID)]
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
decade <- function(y) {
10*floor(y/10)
}
a <- with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(year, boogdat$x.nic.nom==0))
a <- with(all.main, mytable(decade(Year), paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(decade(year), boogdat$x.nic.nom==0))
a
b
yrz <- as.numeric(c(dimnames(b)[[1]], dimnames(a)[[1]]))
yrz <- seq(min(yrz), max(yrz), 10)
a <- a[match(yrz, dimnames(a)[[1]]), ]
b <- b[match(yrz, dimnames(b)[[1]]), ]
a[is.na(a)] <- 0
b[is.na(b)] <- 0
a[, 1] <- a[, 1] + b[, 1]
a[, 3] <- a[, 3] + b[, 2]
dimnames(a)[[1]] <- yrz
format(a[, 4:1], big.mark=",")
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
with(all.main, tapply(ID, Folder, range))
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- all.main$Year[match(all.sub$ID, all.main$ID)]
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
decade <- function(y) {
10*floor(y/10)
}
a <- with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(year, boogdat$x.nic.nom==0))
a <- with(all.main, mytable(decade(Year), paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(decade(year), boogdat$x.nic.nom==0))
a
b
yrz <- as.numeric(c(dimnames(b)[[1]], dimnames(a)[[1]]))
yrz <- seq(min(yrz), max(yrz), 10)
a <- a[match(yrz, dimnames(a)[[1]]), ]
b <- b[match(yrz, dimnames(b)[[1]]), ]
a[is.na(a)] <- 0
b[is.na(b)] <- 0
a[, 1] <- a[, 1] + b[, 1]
a[, 3] <- a[, 3] + b[, 2]
dimnames(a)[[1]] <- yrz
format(a[, 4:1], big.mark=",")
### focus on Static, TFM only to start
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
sd(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
### total up the results for each test (ID)
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(dat)
dat2 <- dat[subdex(dat, hours>0 & hours<100), ]
dat2 <- dat2[!subdex(dat2, ph<1 | ph>14), ]
a <- with(dat2, mytable(decade(year), paste(is.na(ph), cut(hours, seq(0, 80, 8))) ) )
a
hist(dat2$hours)
mytable(round(dat2$hours))
hist(dat2$hours, nclass=50)
locator()
locator()
a <- with(dat2, mytable(decade(year), paste(is.na(ph), cut(hours, seq(0, 80, 10))) ) )
a
with(dat2, mytable(decade(year), cut(hours, seq(0, 80, 10)), is.na(ph)) )
quintade <- function(y) {
5*floor(y/5)
}
a <- with(dat2, mytable(quintade(year), cut(hours, seq(0, 80, 10)), is.na(ph)) )
a
with(dat2, mytable(quintade(year), is.na(ph)) )
with(dat2, mytable(quintade(year), !is.na(ph)) )
with(dat2, mytable(year, !is.na(ph)) )
dat2[dat2$year>1982 & is.na(dat2$ph), ]
head(dat2)
# what's up with the more recent records missing pH
ids <- dimnames(dat2)[[1]][with(dat2, year>1982 & is.na(ph))]
ids
showme <- function(id) {
print(main[main$ID==id, ])
print(sub[sub$ID==id, ])
}
showme()
showme(12750)
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
with(all.main, tapply(ID, Folder, range))
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- all.main$Year[match(all.sub$ID, all.main$ID)]
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
decade <- function(y) {
10*floor(y/10)
}
a <- with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(year, boogdat$x.nic.nom==0))
a <- with(all.main, mytable(decade(Year), paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(decade(year), boogdat$x.nic.nom==0))
a
b
yrz <- as.numeric(c(dimnames(b)[[1]], dimnames(a)[[1]]))
yrz <- seq(min(yrz), max(yrz), 10)
a <- a[match(yrz, dimnames(a)[[1]]), ]
b <- b[match(yrz, dimnames(b)[[1]]), ]
a[is.na(a)] <- 0
b[is.na(b)] <- 0
a[, 1] <- a[, 1] + b[, 1]
a[, 3] <- a[, 3] + b[, 2]
dimnames(a)[[1]] <- yrz
format(a[, 4:1], big.mark=",")
### focus on Static, TFM only to start
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
mean(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
### total up the results for each test (ID)
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(dat)
dat2 <- dat[subdex(dat, hours>0 & hours<100), ]
dat2 <- dat2[!subdex(dat2, ph<1 | ph>14), ]
quintade <- function(y) {
5*floor(y/5)
}
with(dat2, mytable(quintade(year), !is.na(ph)) )
with(dat2, mytable(year, !is.na(ph)) )
# what's up with the more recent records missing pH
ids <- dimnames(dat2)[[1]][with(dat2, year>1982 & is.na(ph))]
ids
showme(12766)
showme <- function(id) {
print(main[main$ID==id, ])
print(sub[sub$ID==id, ])
}
showme(12766)
mytable(main$Folder[main$ID %in% ids])
showme(12773)
showme(16788)
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
# assign a new ID every time a new start date or a new concentration is entered
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
# fill in the blanks for the columns when a new concentration starts
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
filled <- data.frame(lapply(McGarrydat[, !sel], fill))
newconcrows <- is.na(McGarrydat$start.date) & !is.na(McGarrydat$conc.)
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
# assign a new ID every time a new start date or a new concentration is entered
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
# fill in the blanks for the columns when a new concentration starts
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
filled <- data.frame(lapply(McGarrydat[, !sel], fill))
newconcrows <- is.na(McGarrydat$start.date) & !is.na(McGarrydat$conc.)
a <- newconcrows
filled[a, ]
filled[a, ][filled$ID[a]==16788, ]
filled[a, ][filled$Sheet[a]=="8-9-91 US31", ]
cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
cleanup()
graphics.off()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
# keepsub <- c("ID", "Test_Sick", "Test_Dead", 
# "Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
# "concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"concentration_t", "pH_t", "DO_t", "water_temp_t", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
# Sub1$Conc_Target <- Main1$Concentration[sm]
# Sub1$pH_Target <- Main1$pH[sm]
# Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
# Sub2$Conc_Target <- Main1$Concentration[sm]
# Sub2$pH_Target <- Main1$pH[sm]
# Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
combine.comments <- function(df) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df$Comment_ID)
combined <- tapply(df$Comment_ID[sel], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
McGarrydat$Comment_ID <- combine.comments(McGarrydat)
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
m.sub$concentration_t <- fill(m.sub$concentration_t)
m.sub$Test_Species <- fill(m.sub$Test_Species)
m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
Slaghtdat$Comment_ID <- combine.comments(Slaghtdat)
dt1 <- fill(as.numeric(Slaghtdat$Start_Time))
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
k.sub$concentration_t <- fill(k.sub$concentration_t)
k.sub$Test_Species <- fill(k.sub$Test_Species)
k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
Robdat$Comment_ID <- combine.comments(Robdat)
dt1 <- fill(as.numeric(Robdat$Start_Time))
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- fill(hrs)
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
r.sub$Test_Species <- fill(r.sub$Test_Species)
r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(combine.comments, a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
# when a value is provided in main for conc, ph, or alk ... copy this to sub as the "target"
sm <- match(all.sub$ID, all.main$ID)
all.sub$Conc_Target <- all.main$Concentration[sm]
all.sub$pH_Target <- all.main$pH[sm]
all.sub$Alk_Target <- all.main$Total_Alkalinity[sm]
head(all.main)
head(all.sub)
showme
all.main[all.main$ID==16788, ]
all.sub[all.sub$ID==16788, ]
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
look <- all.sub[all.sub$ID %in% setdiff(all.sub$ID, all.main$ID), ]
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
cleanup()
graphics.off()
library(lubridate)
library(LW1949)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
with(all.main, tapply(ID, Folder, range))
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- all.main$Year[match(all.sub$ID, all.main$ID)]
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
decade <- function(y) {
10*floor(y/10)
}
a <- with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(year, boogdat$x.nic.nom==0))
a <- with(all.main, mytable(decade(Year), paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(decade(year), boogdat$x.nic.nom==0))
a
b
yrz <- as.numeric(c(dimnames(b)[[1]], dimnames(a)[[1]]))
yrz <- seq(min(yrz), max(yrz), 10)
a <- a[match(yrz, dimnames(a)[[1]]), ]
b <- b[match(yrz, dimnames(b)[[1]]), ]
a[is.na(a)] <- 0
b[is.na(b)] <- 0
a[, 1] <- a[, 1] + b[, 1]
a[, 3] <- a[, 3] + b[, 2]
dimnames(a)[[1]] <- yrz
format(a[, 4:1], big.mark=",")
### focus on Static, TFM only to start
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
mean(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
sub[sub$ID==16788, ]
### total up the results for each test (ID)
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(dat)
dat2 <- dat[subdex(dat, hours>0 & hours<100), ]
dat2 <- dat2[!subdex(dat2, ph<1 | ph>14), ]
quintade <- function(y) {
5*floor(y/5)
}
with(dat2, mytable(quintade(year), !is.na(ph)) )
with(dat2, mytable(year, !is.na(ph)) )
with(dat2, year==1988 & is.na(ph))
dat2[with(dat2, year==1988 & is.na(ph)), ]
dimnames(dat2)[[1]][with(dat2, year==1988 & is.na(ph))]
# what's up with the more recent records missing pH
ids <- dimnames(dat2)[[1]][with(dat2, year>1976 & is.na(ph))]
ids
showme <- function(id) {
print(main[main$ID==id, ])
print(sub[sub$ID==id, ])
}
showme(12766)
mytable(main$Folder[main$ID %in% ids])
main[main$ID %in% ids, ]
stringin("ph", names(main))
main$pH[main$ID %in% ids, ]
main$pH[main$ID %in% ids]
stringin("ph", names(sub))
sub[sub$ID %in% ids, stringin("ph", names(sub))]
look <- sub[sub$ID %in% ids, stringin("ph", names(sub))]
summary(look)
ids
ids
showme(13966)
showme(13966)
with(dat2, mytable(year, !is.na(ph)) )
with(dat2, mytable(quintade(year), !is.na(ph)) )
head(dat2)
# subset just those with pH data
phids <- dimnames(dat2)[[1]][with(dat2, !is.na(ph))]
phids
length(phids)
with(dat2, mytable(quintade(year), !is.na(ph)) )
marg.tot(with(dat2, mytable(quintade(year), !is.na(ph)) ))
search()
stringin(ls(6), marg)
stringin("marg", ls(6))
stringin("tpt", ls(6))
stringin("tot", ls(6))
ls(6)
with(dat2, mytable(quintade(year), !is.na(ph)) )
addmargins(with(dat2, mytable(quintade(year), !is.na(ph)) ))
# subset just those with pH data
phids <- dimnames(dat2)[[1]][with(dat2, !is.na(ph))]
pmain <- main[main$ID %in% phids, ]
psub <- sub[sub$ID %in% phids, ]
dim(main)
dim(pmain)
dim(sub)
dim(psub)
summary(psub)
# subset just those with pH data
phids <- dimnames(dat2)[[1]][with(dat2, !is.na(ph))]
pmain <- main[main$ID %in% phids, ]
psub <- sub[sub$ID %in% phids, ]
mytable(pmain$Comment_ID)
mytable(psub$Comment_Tank)
unique(pmain$Comment_ID)
unique(psub$Comment_Tank)
stringin("ph", unique(pmain$Comment_ID))
main[main$Comment_ID %in% stringin("ph", unique(pmain$Comment_ID)), ]
stringin("ph", unique(pmain$Comment_ID))
# subset just those with pH data
phids <- dimnames(dat2)[[1]][with(dat2, !is.na(ph))]
# get rid of any ids with ph comments, too
phids2 <- main$ID[main$ID %in% phids & !(main$Comment_ID %in% stringin("ph", unique(main$Comment_ID)))]
pmain <- main[main$ID %in% phids2, ]
psub <- sub[sub$ID %in% phids2 & !(sub$Comment_Tank %in% stringin("ph", unique(sub$Comment_Tank))), ]
setdiff(psub$ID, pmain$ID)
# subset just those with pH data
phids <- dimnames(dat2)[[1]][with(dat2, !is.na(ph))]
# get rid of any ids with ph comments, too
phids2 <- main$ID[main$ID %in% phids & !(main$Comment_ID %in% stringin("ph", unique(main$Comment_ID)))]
pmain <- main[main$ID %in% phids2, ]
psub <- sub[sub$ID %in% phids2 & !(sub$Comment_Tank %in% stringin("ph", unique(sub$Comment_Tank))), ]
setdiff(psub$ID, pmain$ID)
unique(pmain$Comment_ID)
unique(psub$Comment_Tank)
# subset just those with pH data
phids <- dimnames(dat2)[[1]][with(dat2, !is.na(ph))]
# get rid of any ids with ph comments, too
phids2 <- main$ID[main$ID %in% phids & !(main$Comment_ID %in% stringin("ph", unique(main$Comment_ID)))]
pmain <- main[main$ID %in% phids2, ]
psub <- sub[sub$ID %in% phids2 & !(sub$Comment_Tank %in% stringin("ph", unique(sub$Comment_Tank))), ]
setdiff(psub$ID, pmain$ID)
# look at comments
unique(pmain$Comment_ID)
unique(psub$Comment_Tank)
# total up the results for each test (ID)
d <- with(psub, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(psub, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(psub, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(psub, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(psub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(psub, tapply(Year, ID, mean, na.rm=TRUE))
pdat <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
head(pdat)
plotdf(pdat)
pdat <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
pdat$pdead <- with(pdat, ndead/ntest)
head(pdat)
rm(d, n, h, c, p, y)
attach(pdat)
plot(conc, pdead)
graphics.off()
graphics.off()
graphics.off()
plot(conc, pdead)
plot(log10(conc), probit(pdead))
pairs(pdat)
plot(ph, hours)
round(hours)
rev(sort(unique(round(hours)))
)
unique(round(hours))
mytable(round(hours))
rev(sort(mytable(round(hours))))
mytable(round(hours), quintade(year))
t(mytable(round(hours), quintade(year)))
t(mytable(round(hours), quintade(year)))
cut(hours, c(0, 8, 10, 23, 25, 48))
mytable(cut(hours, c(0, 8, 10, 23, 25, 48)))
mytable(cut(hours, c(0, 7.5, 10.5, 23.5, 25.5, 48)))
mytable(round(hours), quintade(year))
dim(mytable(round(hours), quintade(year)))
library(nlme)
?nlme
library(lme4)
?nlmer
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
length(ids24)
mytable(round(hours), quintade(year))
marginals(mytable(round(hours), quintade(year)))
addmargins(mytable(round(hours), quintade(year)))
length(ids24)
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
# get rid of any ids with ph comments, too
ids24 <- main$ID[main$ID %in% ids24 & !(main$Comment_ID %in% stringin("ph", unique(main$Comment_ID)))]
length(ids24)
unique(main$Comment_ID[main$ID %in% ids24 ])
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
unique(main$Comment_ID[main$ID %in% ids24])
unique(sub$Comment_ID[sub$ID %in% ids24])
stringin("24", unique(main$Comment_ID[main$ID %in% ids24]))
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
unique(main$Comment_ID[main$ID %in% ids24])
unique(sub$Comment_ID[sub$ID %in% ids24])
# get rid of any ids with ph comments, too
main24 <- main[main$ID %in% ids24, ]
sub24 <- sub[sub$ID %in% ids24, ]
setdiff(psub$ID, pmain$ID)
summary(main24)
summary(sub24)
table(main24$Aerated)
mytable(main24$Aerated)
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
unique(main$Comment_ID[main$ID %in% ids24])
unique(sub$Comment_ID[sub$ID %in% ids24])
# get rid of any ids with ph comments, too
main24 <- main[main$ID %in% ids24, ]
sub24 <- sub[sub$ID %in% ids24, ]
setdiff(psub$ID, pmain$ID)
mytable(main24$Aerated)
# total up the results for each test (ID)
d <- with(sub24, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub24, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub24, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(sub24, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(sub24, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub24, tapply(Year, ID, mean, na.rm=TRUE))
dat24 <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
dat24$pdead <- with(dat24, ndead/ntest)
head(dat24)
rm(d, n, h, c, p, y)
attach(dat24)
plot(conc, pdead)
search()
find("hours")
detach(6)
plot(conc, pdead)
plot(log10(conc), probit(pdead))
summary(ph)
search()
stringin("col", ls(10))
colr
plot(log10(conc), probit(pdead), col=colr(ph, "yellow", "blue"))
plot(log10(conc), probit(pdead), col=colr(ph, "yellow", "blue"), pch=16)
xyplot(pdead ~ conc | ph)
library(lattice)
xyplot(pdead ~ conc | ph)
?xyplot
plot(log10(conc), probit(pdead), col=colr(ph, "yellow", "blue"), pch=16)
plot(log10(conc), probit(pdead), col=colr(ph, "yellow", "blue"), pch=16)
windows()
plot(log10(conc), probit(pdead), col=colr(year, "yellow", "blue"), pch=16)
fit <- gam(probit(pdead) ~ log10(conc) + s(year) + s(ph))
ppdead <- probit(pdead)
lconc <- log10(conc)
fit <- gam(ppdead ~ lconc + s(year) + s(ph))
search()
detach(3)
# total up the results for each test (ID)
d <- with(sub24, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub24, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub24, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(sub24, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(sub24, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub24, tapply(Year, ID, mean, na.rm=TRUE))
dat24 <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
dat24$pdead <- with(dat24, ndead/ntest)
dat24$ppdead <- probit(dat24$pdead)
dat24$lconc <- log10(dat24$conc)
head(dat24)
rm(d, n, h, c, p, y)
summary(dat24)
dat24[, is.na(conc)]
dat24[, is.na(dat24$conc)]
dat24$conc
is.na(dat24$conc)
dat24[, is.na(dat24$conc)]
dat24[is.na(dat24$conc), ]
rownames(dat24[is.na(dat24$conc), ])
showme
showme(12748)
showme(12748)
dat24 <- dat24[!is.na(dat24), ]
head(dat24)
rm(d, n, h, c, p, y)
attach(dat24)
search()
rm(lconc)
rm(ppdead)
fit <- gam(ppdead ~ lconc + s(year) + s(ph))
summary(dat24)
detach()
# total up the results for each test (ID)
d <- with(sub24, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub24, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub24, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(sub24, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(sub24, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub24, tapply(Year, ID, mean, na.rm=TRUE))
dat24 <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
dat24$pdead <- with(dat24, ndead/ntest)
dat24$ppdead <- probit(dat24$pdead)
dat24$lconc <- log10(dat24$conc)
dat24 <- dat24[!is.na(dat24$conc), ]
head(dat24)
rm(d, n, h, c, p, y)
summary(dat24)
dat24 <- dat24[!is.na(dat24$conc) & dat24$ntest > 0, ]
# total up the results for each test (ID)
d <- with(sub24, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub24, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub24, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(sub24, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(sub24, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub24, tapply(Year, ID, mean, na.rm=TRUE))
dat24 <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
dat24$pdead <- with(dat24, ndead/ntest)
dat24$ppdead <- probit(dat24$pdead)
dat24$lconc <- log10(dat24$conc)
dat24 <- dat24[!is.na(dat24$conc) & dat24$ntest > 0, ]
summary(dat24)
# total up the results for each test (ID)
d <- with(sub24, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub24, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub24, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(sub24, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(sub24, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub24, tapply(Year, ID, mean, na.rm=TRUE))
dat24 <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
dat24$pdead <- with(dat24, ndead/ntest)
dat24$ppdead <- probit(dat24$pdead)
dat24$lconc <- log10(dat24$conc)
dat24 <- dat24[subdex(dat24, conc>0 & ntest>0, ]
search()
# total up the results for each test (ID)
d <- with(sub24, tapply(Test_Dead, ID, sum, na.rm=TRUE))
n <- with(sub24, tapply(Number_Tested, ID, sum, na.rm=TRUE))
h <- with(sub24, tapply(Hours, ID, max, na.rm=TRUE))
c <- with(sub24, tapply(conc_use, ID, mean, na.rm=TRUE))
p <- with(sub24, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub24, tapply(Year, ID, mean, na.rm=TRUE))
dat24 <- data.frame(ndead=d, ntest=n, hours=h, conc=c, ph=p, year=y)
dat24$pdead <- with(dat24, ndead/ntest)
dat24$ppdead <- probit(dat24$pdead)
dat24$lconc <- log10(dat24$conc)
dat24 <- dat24[subdex(dat24, conc>0 & ntest>0), ]
summary(dat24)
fit <- gam(ppdead ~ lconc + s(year) + s(ph), data=dat24)
fit <- gam(ppdead ~ lconc + s(year) + s(ph), data=dat24[subdex(dat24, pdead>0), ])
summary(fit)
plot(fit)
fit <- gam(ppdead ~ lconc + s(year, k=4) + s(ph, k=4), weights=ntest, data=dat24[subdex(dat24, pdead>0), ])
plot(fit)
fit <- gam(ppdead ~ lconc + s(year, k=5) + s(ph, k=5), weights=ntest, data=dat24[subdex(dat24, pdead>0), ])
summary(fit)
fit <- gam(ppdead ~ lconc + s(year, k=6) + s(ph, k=6), weights=ntest, data=dat24[subdex(dat24, pdead>0), ])
summary(fit)
fit <- gam(ppdead ~ lconc + s(ph, k=6) + s(year, k=6), weights=ntest, data=dat24[subdex(dat24, pdead>0), ])
summary(fit)
fit <- gam(ppdead ~ lconc + s(ph) + s(year), weights=ntest, data=dat24[subdex(dat24, pdead>0), ])
summary(fit)
plot(fit)
fit <- gam(ppdead ~ lconc + s(ph, k=4) + s(year, k=4), weights=ntest, data=dat24[subdex(dat24, pdead>0), ])
summary(fit)
fit <- gam(ppdead ~ lconc + s(ph, k=5) + s(year, k=5), weights=ntest, data=dat24[subdex(dat24, pdead>0), ])
summary(fit)
plot(fit)
fit <- lm(ppdead ~ lconc + poly(ph, 3) + year, weights=ntest, data=dat24[subdex(dat24, pdead>0), ])
summary(fit)
conflicts()
cleanup()
q()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
library(lubridate)
library(LW1949)
library(lattice)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
with(all.main, tapply(ID, Folder, range))
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- all.main$Year[match(all.sub$ID, all.main$ID)]
##### need to bring in other summary data ???
source("C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/ReadBoogaard.r")
head(boogdat, 3)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note   Folder
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> Boogaard
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> Boogaard
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> Boogaard
boogdat$year <- year(boogdat$date)
b2 <- boogdat[boogdat$x.nic.nom==0, ]
names(b2) <- recode(names(b2), c("dead", "total", "tfm", "ph.ave"), c("ndead", "ntest", "conc", "ph"))
b2$hours <- 12
head(b2)
decade <- function(y) {
10*floor(y/10)
}
a <- with(all.main, mytable(Year, paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(year, boogdat$x.nic.nom==0))
a <- with(all.main, mytable(decade(Year), paste(Chemical=="TFM", Test_Type)))[, c(1, 4, 5, 7)]
b <- with(boogdat, mytable(decade(year), boogdat$x.nic.nom==0))
a
b
yrz <- as.numeric(c(dimnames(b)[[1]], dimnames(a)[[1]]))
yrz <- seq(min(yrz), max(yrz), 10)
a <- a[match(yrz, dimnames(a)[[1]]), ]
b <- b[match(yrz, dimnames(b)[[1]]), ]
a[is.na(a)] <- 0
b[is.na(b)] <- 0
a[, 1] <- a[, 1] + b[, 1]
a[, 3] <- a[, 3] + b[, 2]
dimnames(a)[[1]] <- yrz
format(a[, 4:1], big.mark=",")
### focus on Static, TFM only to start
# subset data for analysis
msel <- subdex(all.main, Test_Type=="Static" & Chemical=="TFM")
ssel <- subdex(all.sub, Species==2)
ids <- intersect(all.main$ID[msel], all.sub$ID[ssel])
main <- all.main[all.main$ID %in% ids, ]
sub <- all.sub[subdex(all.sub, ID %in% ids & Species==2), ]
### determine what concentration and pH values to use
replaceval <- function(id, target1, mean2) {
# start with the target value
usethis <- target1
# if the target value is missing, use the mean of the line-by-line values
idnotarg <- sort(unique(id[is.na(target1)]))
usethis[id %in% idnotarg] <- mean2[id %in% idnotarg]
usethis
}
meannozero <- function(x) {
mean(x[x>0 & !is.na(x)])
}
meanz <- with(sub, aggregate(cbind(concentration_t, pH_t), list(ID=ID), meannozero))
names(meanz) <- c("ID", "conc_mean", "pH_mean")
sub <- merge(sub, meanz, all=TRUE)
sub$conc_use <- with(sub, replaceval(ID, Conc_Target, conc_mean))
sub$pH_use <- with(sub, replaceval(ID, pH_Target, pH_mean))
### total up the results for each test (ID)
h <- with(sub, tapply(Hours, ID, max, na.rm=TRUE))
p <- with(sub, tapply(pH_use, ID, mean, na.rm=TRUE))
y <- with(sub, tapply(Year, ID, mean, na.rm=TRUE))
dat <- data.frame(hours=h, ph=p, year=y)
head(dat)
dat2 <- dat[subdex(dat, hours>0 & hours<100), ]
dat2 <- dat2[!subdex(dat2, ph<1 | ph>14), ]
quintade <- function(y) {
5*floor(y/5)
}
with(dat2, mytable(quintade(year), !is.na(ph)) )
with(dat2, mytable(year, !is.na(ph)) )
# what's up with the more recent records missing pH
ids <- dimnames(dat2)[[1]][with(dat2, year>1976 & is.na(ph))]
ids
showme <- function(id) {
print(main[main$ID==id, ])
print(sub[sub$ID==id, ])
}
showme(12766)
mytable(main$Folder[main$ID %in% ids])
main[main$ID %in% ids, ]
look <- sub[sub$ID %in% ids, stringin("ph", names(sub))]
summary(look)
# subset just those with pH data
phids <- dimnames(dat2)[[1]][with(dat2, !is.na(ph))]
# get rid of any ids with ph comments, too
phids2 <- main$ID[main$ID %in% phids & !(main$Comment_ID %in% stringin("ph", unique(main$Comment_ID)))]
pmain <- main[main$ID %in% phids2, ]
psub <- sub[sub$ID %in% phids2 & !(sub$Comment_Tank %in% stringin("ph", unique(sub$Comment_Tank))), ]
setdiff(psub$ID, pmain$ID)
# look at comments
unique(pmain$Comment_ID)
unique(psub$Comment_Tank)
# total up the results for each test (ID)
h <- with(psub, tapply(Hours, ID, max, na.rm=TRUE))
y <- with(psub, tapply(Year, ID, mean, na.rm=TRUE))
pdat <- data.frame(hours=h, year=y)
head(pdat)
mytable(round(hours), quintade(year))
rm(h, y)
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
unique(main$Comment_ID[main$ID %in% ids24])
unique(sub$Comment_ID[sub$ID %in% ids24])
# get rid of any ids with ph comments, too
main24 <- main[main$ID %in% ids24, ]
sub24 <- sub[sub$ID %in% ids24, ]
setdiff(psub$ID, pmain$ID)
mytable(main24$Aerated)
x <- as.numeric(interaction(main24[, c("Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")],
drop=TRUE))
plot(x)
length(unique(x))
table(x)
dim(main24)
summary(table(x))
median(table(x))
main24$group <- as.numeric(
interaction(main24[, c("Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")],
drop=TRUE))
main24[main24$group==9, ]
dim(main24)
length(x)
main24$group
?order
main24[order(main24[, c("Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")]), ]
dput(names(main24)
)
main24[order(main24[, c("Folder", "File", "Sheet", "Row", "ID", 
"Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")]), ]
order(data.frame(a=c(1, 4, 5, 3, 3), b=c(1, 1, 1, 2, 1))))
order(data.frame(a=c(1, 4, 5, 3, 3), b=c(1, 1, 1, 2, 1)))
data.frame(a=c(1, 4, 5, 3, 3), b=c(1, 1, 1, 2, 1)))
data.frame(a=c(1, 4, 5, 3, 3), b=c(1, 1, 1, 2, 1))
ord <- with(main24, order, Folder, File, Sheet, Row, ID, Lake, Stream, Water_Not_Lake_Or_Stream, Location, Lab, Start_Date, Formulation)
ord
ord <- with(main24, order(Folder, File, Sheet, Row, ID, Lake, Stream, Water_Not_Lake_Or_Stream, Location, Lab, Start_Date, Formulation))
ord
main24$group <- as.numeric(
interaction(main24[, c("Folder", "File", "Sheet", "Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")],
drop=TRUE, lex.order=TRUE))
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
unique(main$Comment_ID[main$ID %in% ids24])
unique(sub$Comment_ID[sub$ID %in% ids24])
# get rid of any ids with ph comments, too
main24 <- main[main$ID %in% ids24, ]
sub24 <- sub[sub$ID %in% ids24, ]
setdiff(psub$ID, pmain$ID)
mytable(main24$Aerated)
main24$group <- as.numeric(
interaction(main24[, c("Folder", "File", "Sheet", "Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")],
drop=TRUE, lex.order=TRUE))
ord <- with(main24, order(Folder, File, Sheet, Row, ID, Lake, Stream, Water_Not_Lake_Or_Stream, Location, Lab, Start_Date, Formulation))
main24 <- main24[ord, ]
main24
main24
apply(main24[, groupvars], 1, paste, collapse="-")
groupvars <- c("Folder", "File", "Sheet", "Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")
apply(main24[, groupvars], 1, paste, collapse="-")
groupvars <- c("Folder", "File", "Sheet", "Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")
main24$group <- as.numeric(as.factor(apply(main24[, groupvars], 1, paste, collapse="-")))
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
unique(main$Comment_ID[main$ID %in% ids24])
unique(sub$Comment_ID[sub$ID %in% ids24])
# get rid of any ids with ph comments, too
main24 <- main[main$ID %in% ids24, ]
sub24 <- sub[sub$ID %in% ids24, ]
setdiff(psub$ID, pmain$ID)
mytable(main24$Aerated)
groupvars <- c("Folder", "File", "Sheet", "Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Lab", "Start_Date", "Formulation")
main24$group <- as.numeric(as.factor(apply(main24[, groupvars], 1, paste, collapse="-")))
ord <- with(main24, order(Folder, File, Sheet, Row, ID, Lake, Stream, Water_Not_Lake_Or_Stream, Location, Lab, Start_Date, Formulation))
main24 <- main24[ord, ]
main24
mytable(main24$group)
summary(mytable(main24$group))
summary(as.numeric(mytable(main24$group)))
dput(names(main24))
main24[, c("group", "ID", groupvars, "Concentration", "pH", "Total_Alkalinity")]
dim(main24)
# subset just those tests that lasted 24 hours (+/- 1)
ids24 <- dimnames(pdat)[[1]][with(pdat, round(hours) %in% 23:25)]
unique(main$Comment_ID[main$ID %in% ids24])
unique(sub$Comment_ID[sub$ID %in% ids24])
# get rid of any ids with ph comments, too
main24 <- main[main$ID %in% ids24, ]
sub24 <- sub[sub$ID %in% ids24, ]
setdiff(psub$ID, pmain$ID)
mytable(main24$Aerated)
groupvars <- c("Folder", "File", "Sheet", "Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Start_Date", "Formulation")
main24$group <- as.numeric(as.factor(apply(main24[, groupvars], 1, paste, collapse="-")))
ord <- with(main24, order(Folder, File, Sheet, Row, ID, Lake, Stream, Water_Not_Lake_Or_Stream, Location, Start_Date, Formulation))
main24 <- main24[ord, ]
main24[, c("group", "ID", groupvars, "Concentration", "pH", "Total_Alkalinity")]
main24[, c("group", "ID", "Row", groupvars, "Concentration", "pH", "Total_Alkalinity")]
ord <- with(main24, order(Folder, File, Sheet, Row, ID, Lake, Stream, Water_Not_Lake_Or_Stream, Location, Start_Date, Formulation))
main24 <- main24[ord, ]
groupvars <- c("Folder", "File", "Sheet", "Lake", "Stream", "Water_Not_Lake_Or_Stream", "Location", "Start_Date", "Formulation")
grouplong <- apply(main24[, groupvars], 1, paste, collapse="-")
main24$group <- as.numeric(as.factor(grouplong))
main24[, c("group", "ID", "Row", groupvars, "Concentration", "pH", "Total_Alkalinity")]
grouplong[main24$group < 6]
cleanup()
q()
# C:\JVA\Consult\Hansen\vonBgrowth\Musky_growth3 - JVA.R
# Load required libraries:
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
# Visualise the data (ignored for now...):
# plot(datgr)
xyplot(L ~ Age | Sex, datgr)
# Declare growth functions:
LVB = function(x, t0, Lmax, K) {
y = Lmax*(1-exp(-K*(x-t0)))
y
}
# Fit a LVB model by NLME. 
# If the model does not converge, try changing starting values:
LVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr, fixed= list(t0 ~ 1, Lmax ~ 1, K ~ 1), random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, Lmax=46, K=0.18)))
# Display results:
summary(LVB.nlme)
intervals(LVB.nlme)
anova(LVB.nlme)
head(coef(LVB.nlme))
co <- coef(LVB.nlme)
co$Sex <- datgr$Sex[match(dimnames(co)[[1]], datgr$id)]
head(co)
windows()
with(co, plot(Sex, t0))
windows()
with(co, plot(Sex, Lmax))
windows()
with(co, plot(Sex, K))
LVBabc.nlme = update(LVB.nlme, fixed= list(t0 ~ Sex, Lmax ~ Sex, K ~ Sex),
start=list(fixed=c(-0.44, 0, 0, 46, 0, 0, 0.18, 0, 0)), verbose=TRUE)
a <- .Last.value()
oops()
LVBabc.nlme
?nlme
dfclip()
dfclip()
df <- dfclip()
dput(df)
param <- structure(list(t1 = c(-0.475572, -0.481336, -0.476846, -0.481217, 
-0.476786, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226), tt2 = c(0.0663798, 
0.0690005, 0.0680161, 0.0690183, 0.068018, 0.06902, 0.068017, 
0.06902, 0.0680171, 0.0690201, 0.0680171, 0.06902, 0.0680169, 
0.0690201, 0.0680169, 0.06902, 0.0680169, 0.0690201, 0.068017, 
0.0690202, 0.0680171, 0.06902, 0.0680169, 0.0690201, 0.0680171, 
0.0690201, 0.068017, 0.0690199, 0.0680169, 0.0690201, 0.0680169, 
0.0690202, 0.0680171, 0.0690201, 0.0680171, 0.0690201, 0.0680169, 
0.0690201, 0.068017, 0.0690199, 0.0680171, 0.0690202, 0.0680172, 
0.0690201, 0.0680171, 0.0690202, 0.068017, 0.0690202, 0.068017, 
0.0690202), t3 = c(0.0148589, 0.0126283, 0.00282307, 0.00406954, 
0.00190332, 0.00404403, 0.00189985, 0.00404409, 0.00189981, 0.00404413, 
0.00189991, 0.00404401, 0.00189975, 0.00404414, 0.00189962, 0.00404404, 
0.00189971, 0.00404419, 0.00190001, 0.00404428, 0.00190002, 0.00404402, 
0.00189985, 0.00404414, 0.00189992, 0.00404423, 0.00189987, 0.00404396, 
0.0018997, 0.0040442, 0.00189981, 0.00404417, 0.00189992, 0.00404434, 
0.00189989, 0.00404413, 0.00189982, 0.00404415, 0.00189987, 0.00404398, 
0.00190005, 0.00404423, 0.00189997, 0.0040441, 0.00189995, 0.00404426, 
0.00189988, 0.00404413, 0.00189979, 0.0040443), lmax1 = c(50.0256, 
50.2856, 50.0821, 50.2767, 50.0789, 50.277, 50.0787, 50.277, 
50.0787, 50.277, 50.0787, 50.277, 50.0786, 50.277, 50.0786, 50.277, 
50.0786, 50.277, 50.0787, 50.277, 50.0787, 50.277, 50.0786, 50.277, 
50.0787, 50.277, 50.0786, 50.277, 50.0786, 50.277, 50.0786, 50.277, 
50.0787, 50.277, 50.0786, 50.277, 50.0786, 50.277, 50.0787, 50.277, 
50.0787, 50.277, 50.0787, 50.277, 50.0787, 50.277, 50.0786, 50.277, 
50.0786, 50.277), lmax2 = c(-7.85733, -7.99794, -7.91766, -7.99568, 
-7.91647, -7.99574, -7.91638, -7.99574, -7.91637, -7.99574, -7.91637, 
-7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, 
-7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, 
-7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, 
-7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, 
-7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, 
-7.91637, -7.99574, -7.91637, -7.99574), lmax3 = c(1.19586, 1.19665, 
1.6258, 1.58725, 1.66956, 1.58841, 1.6697, 1.58842, 1.66971, 
1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 
1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 
1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 
1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 
1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 
1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842), k1 = c(0.161988, 
0.160708, 0.16181, 0.160739, 0.161827, 0.160737, 0.161828, 0.160737, 
0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 
0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 
0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 
0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 
0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 
0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737
), k2 = c(0.0341601, 0.0347107, 0.0344762, 0.0347181, 0.034478, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719), k3 = c(-0.0193853, -0.0194215, 
-0.0215717, -0.0211127, -0.0217376, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161
)), .Names = c("t1", "tt2", "t3", "lmax1", "lmax2", "lmax3", 
"k1", "k2", "k3"), class = "data.frame", row.names = c(NA, -50L
))
head(param)
param$iter <- 1:50
head(param)
param <- structure(list(t1 = c(-0.475572, -0.481336, -0.476846, -0.481217, 
-0.476786, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226, -0.476781, -0.481226, 
-0.476781, -0.481226, -0.476781, -0.481226), tt2 = c(0.0663798, 
0.0690005, 0.0680161, 0.0690183, 0.068018, 0.06902, 0.068017, 
0.06902, 0.0680171, 0.0690201, 0.0680171, 0.06902, 0.0680169, 
0.0690201, 0.0680169, 0.06902, 0.0680169, 0.0690201, 0.068017, 
0.0690202, 0.0680171, 0.06902, 0.0680169, 0.0690201, 0.0680171, 
0.0690201, 0.068017, 0.0690199, 0.0680169, 0.0690201, 0.0680169, 
0.0690202, 0.0680171, 0.0690201, 0.0680171, 0.0690201, 0.0680169, 
0.0690201, 0.068017, 0.0690199, 0.0680171, 0.0690202, 0.0680172, 
0.0690201, 0.0680171, 0.0690202, 0.068017, 0.0690202, 0.068017, 
0.0690202), t3 = c(0.0148589, 0.0126283, 0.00282307, 0.00406954, 
0.00190332, 0.00404403, 0.00189985, 0.00404409, 0.00189981, 0.00404413, 
0.00189991, 0.00404401, 0.00189975, 0.00404414, 0.00189962, 0.00404404, 
0.00189971, 0.00404419, 0.00190001, 0.00404428, 0.00190002, 0.00404402, 
0.00189985, 0.00404414, 0.00189992, 0.00404423, 0.00189987, 0.00404396, 
0.0018997, 0.0040442, 0.00189981, 0.00404417, 0.00189992, 0.00404434, 
0.00189989, 0.00404413, 0.00189982, 0.00404415, 0.00189987, 0.00404398, 
0.00190005, 0.00404423, 0.00189997, 0.0040441, 0.00189995, 0.00404426, 
0.00189988, 0.00404413, 0.00189979, 0.0040443), lmax1 = c(50.0256, 
50.2856, 50.0821, 50.2767, 50.0789, 50.277, 50.0787, 50.277, 
50.0787, 50.277, 50.0787, 50.277, 50.0786, 50.277, 50.0786, 50.277, 
50.0786, 50.277, 50.0787, 50.277, 50.0787, 50.277, 50.0786, 50.277, 
50.0787, 50.277, 50.0786, 50.277, 50.0786, 50.277, 50.0786, 50.277, 
50.0787, 50.277, 50.0786, 50.277, 50.0786, 50.277, 50.0787, 50.277, 
50.0787, 50.277, 50.0787, 50.277, 50.0787, 50.277, 50.0786, 50.277, 
50.0786, 50.277), lmax2 = c(-7.85733, -7.99794, -7.91766, -7.99568, 
-7.91647, -7.99574, -7.91638, -7.99574, -7.91637, -7.99574, -7.91637, 
-7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, 
-7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, 
-7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, 
-7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, 
-7.99574, -7.91637, -7.99574, -7.91637, -7.99574, -7.91637, -7.99574, 
-7.91637, -7.99574, -7.91637, -7.99574), lmax3 = c(1.19586, 1.19665, 
1.6258, 1.58725, 1.66956, 1.58841, 1.6697, 1.58842, 1.66971, 
1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 
1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 
1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 
1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 
1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842, 
1.66971, 1.58842, 1.66971, 1.58842, 1.66971, 1.58842), k1 = c(0.161988, 
0.160708, 0.16181, 0.160739, 0.161827, 0.160737, 0.161828, 0.160737, 
0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 
0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 
0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 
0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 
0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 
0.160737, 0.161828, 0.160737, 0.161828, 0.160737, 0.161828, 0.160737
), k2 = c(0.0341601, 0.0347107, 0.0344762, 0.0347181, 0.034478, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719, 0.0344778, 0.034719, 0.0344778, 
0.034719, 0.0344778, 0.034719), k3 = c(-0.0193853, -0.0194215, 
-0.0215717, -0.0211127, -0.0217376, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161, 
-0.0217384, -0.0211161, -0.0217384, -0.0211161, -0.0217384, -0.0211161
)), .Names = c("t1", "tt2", "t3", "lmax1", "lmax2", "lmax3", 
"k1", "k2", "k3"), class = "data.frame", row.names = c(NA, -50L
))
windows()
par(mfrow=c(3, 3))
apply(param, 2, function(y), plot(1:50, y))
apply(param, 2, function(y) plot(1:50, y))
apply(param, 2, function(y) plot(1:50, y, type="l", lwd=2))
apply(param, 2, function(y) plot(1:50, y, type="l"))
apply(param, 2, function(y) plot(1:50, y, type="l", las=1))
par(mfrow=c(3, 3), mar=c(4, 4, 1, 1), las=1)
apply(param, 2, function(y) plot(1:50, y, type="l"))
apply(param, 2, range)
apply(param, 2, range)
range(param[, 1:3])
yranges <- list(range(param[, 1:3]), range(param[, 4:6]), range(param[, 7:9]))
windows()
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 2, 0, 0), las=1)
for(i in 1:9) {
group <- floor(i/3) + 1
plot(1:50, param[, 1], type="l", ylim=yranges[[group]], xlab="", ylab="", main=names(param)[1])
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE)
yranges
group
9/3
yranges <- list(range(param[, 1:3]), range(param[, 4:6]), range(param[, 7:9]))
windows()
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 2, 0, 0), las=1)
for(i in 1:9) {
group <- floor(i/3)
plot(1:50, param[, 1], type="l", ylim=yranges[[group]], xlab="", ylab="", main=names(param)[1])
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE)
yranges <- list(range(param[, 1:3]), range(param[, 4:6]), range(param[, 7:9]))
windows()
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 2, 0, 0), las=1)
for(i in 1:9) {
group <- floor(i/3)
plot(1:50, param[, i], type="l", ylim=yranges[[group]], xlab="", ylab="", main=names(param)[i])
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE)
i
group <- floor(i/3)
group
i/3
floor(i+1/3)
floor((1:9)+1/3)
floor(((1:9)+1)/3)
floor(((1:9))/3)
floor(((1:9)-1)/3)
floor(((1:9)-1)/3)+1
windows()
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 2, 0, 0), las=1)
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", ylim=yranges[[group]], xlab="", ylab="", main=names(param)[i])
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE)
yranges <- list(range(param[, 1:3]), range(param[, 4:6]), range(param[, 7:9]))
windows()
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 2, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", ylim=yranges[[group]], las=1, xlab="", ylab="", main=names(param)[i])
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE)
windows(h=9, w=6.5)
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 2, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", ylim=yranges[[group]], las=1, xlab="", ylab="", main=names(param)[i])
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE)
yranges <- list(range(param[, 1:3]), range(param[, 4:6]), range(param[, 7:9]))
windows()
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 2, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xlab="", ylab="", main=names(param)[i])#, ylim=yranges[[group]]
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE)
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 2, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xlab="", ylab="", main=names(param)[i])#, ylim=yranges[[group]]
}
mtext("Iteration", side=1, outer=TRUE, line=1)
mtext("Parameter estimate", side=2, outer=TRUE, line=1)
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xlab="", ylab="", main=names(param)[i])#, ylim=yranges[[group]]
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=1)
co
windows()
pairs(co)
pairs(co[, 1:3])
summary(LVB.nlme)
# C:\JVA\Consult\Hansen\vonBgrowth\LT_growth - JVA.R
# Load required libraries
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr = groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MyData.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(mm)"))
datgr$Morph <- as.factor(datgr$Morph)
# visualise the data (ignored for now):
# plot(datgr)
xyplot(L ~ Age | Morph, datgr)
# Declare growth function:
LVB = function(x, t0, Lmax, K) {
y = Lmax*(1-exp(-K*(x-t0)))
y
}
# Fit a LVB model by NLME:
# If the model does not converge, try changing starting values (bold):
LVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr, fixed= t0 + Lmax + K ~ 1, random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-1.0, Lmax=550, K=0.1)))
# Display results:
summary(LVB.nlme)
# C:\JVA\Consult\Hansen\vonBgrowth\Musky_growth3 - JVA.R
# Load required libraries:
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
# Visualise the data (ignored for now...):
# plot(datgr)
xyplot(L ~ Age | Sex, datgr)
# Declare growth functions:
LVB = function(x, t0, Lmax, K) {
y = Lmax*(1-exp(-K*(x-t0)))
y
}
# Fit a LVB model by NLME. 
# If the model does not converge, try changing starting values:
LVB.nlme = nlme(L ~ LVB(Age, t0, Lmax, K), data=datgr, fixed= list(t0 ~ 1, Lmax ~ 1, K ~ 1), random= t0 + Lmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, Lmax=46, K=0.18)))
# Display results:
summary(LVB.nlme)
intervals(LVB.nlme)
anova(LVB.nlme)
head(coef(LVB.nlme))
co <- coef(LVB.nlme)
windows()
pairs(co[, 1:3])
windows()
pairs(coef(LVB.nlme))
yranges <- list(range(param[, 1:3]), range(param[, 4:6]), range(param[, 7:9]))
windows()
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xlab="", ylab="", main=names(param)[i])#, ylim=yranges[[group]]
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=1)
windows(w=9, h=6.5)
par(mfrow=c(3, 3), mar=c(3, 3, 2, 1), oma=c(2, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xlab="", ylab="", main=names(param)[i])#, ylim=yranges[[group]]
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=1)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(3, 3, 2, 1), oma=c(2, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xlab="", ylab="", main=names(param)[i])#, ylim=yranges[[group]]
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=1)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 3, 2, 1), oma=c(2, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab="", main=names(param)[i])#, ylim=yranges[[group]]
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=1)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 3, 0, 1), oma=c(2, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab="")
mtext(names(param)[i], side=3, line==-3, font=2)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=1)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 3, 0, 1), oma=c(2, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab="")
mtext(names(param)[i], side=3, line=-3, font=2)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=1)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 3, 0, 1), oma=c(4, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=3)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 4, 0, 1), oma=c(4, 3, 0, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=3)
?par
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 4, 0, 1), oma=c(4, 3, 0, 0), mgp=c(4, 1, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab="")
title(ylab=names(param)[i], cex=1)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=3)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 4, 0, 1), oma=c(4, 3, 0, 0), mgp=c(4, 1, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
#title(ylab=names(param)[i], cex=1)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=3)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 5, 0, 1), oma=c(4, 3, 0, 0), mgp=c(4, 1, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
#title(ylab=names(param)[i], cex=1)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=3)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 6, 0, 1), oma=c(4, 0, 0, 0), mgp=c(5, 1, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
#title(ylab=names(param)[i], cex=1)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=3)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 6, 0, 1), oma=c(4, 0, 0, 0), mgp=c(5, 1, 0), cex=1.2)
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
#title(ylab=names(param)[i], cex=1)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=3)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 6, 0, 1), oma=c(4, 0, 0, 0), mgp=c(5, 1, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
title(ylab=names(param)[i], cex=1)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE)
mtext("Parameter estimate", side=2, outer=TRUE, line=3)
title(ylab=names(param)[i], cex=1)
title(ylab=names(param)[i], cex=3)
title(ylab=names(param)[i], cex=3)
windows(h=9, w=6.5)
par(mfrow=c(9, 1), mar=c(0, 6, 0, 1), oma=c(4, 0, 0, 0), mgp=c(5, 1, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
title(ylab=names(param)[i], cex=1)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE, line=3)
windows(h=9, w=4.5)
par(mfrow=c(9, 1), mar=c(0, 6, 0, 1), oma=c(4, 0, 0, 0), mgp=c(5, 1, 0))
for(i in 1:9) {
group <- floor((i-1)/3)+1
plot(1:50, param[, i], type="l", las=1, xaxt="n", xlab="", ylab=names(param)[i])
title(ylab=names(param)[i], cex=1)
if(i==1) axis(1, outer=TRUE)
}
mtext("Iteration", side=1, outer=TRUE, line=3)
log(46)
log(0.18)
LVBconstrained = function(x, t0, logLmax, logK) {
exp(logLmax)*(1-exp(-exp(logK)*(x-t0)))
}
LVB.nlme = nlme(L ~ LVBconstrained(Age, t0, logLmax, logK), data=datgr, 
fixed= list(t0 ~ 1, logLmax ~ 1, logK ~ 1), random= t0 + logLmax + logK ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, logLmax=3.8, logK=-1.7)))
# C:\JVA\Consult\Hansen\vonBgrowth\Musky_growth3 - JVA.R
# Load required libraries:
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
# Visualise the data (ignored for now...):
# plot(datgr)
xyplot(L ~ Age | Sex, datgr)
# Declare growth functions:
LVB = function(x, t0, Lmax, K) {
y = Lmax*(1-exp(-K*(x-t0)))
y
}
graphics.off()
LVBconstrained = function(x, t0, logLmax, logK) {
exp(logLmax)*(1-exp(-exp(logK)*(x-t0)))
}
LVB.nlme = nlme(L ~ LVBconstrained(Age, t0, logLmax, logK), data=datgr, 
fixed= list(t0 ~ 1, logLmax ~ 1, logK ~ 1), random= t0 + logLmax + logK ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, logLmax=3.8, logK=-1.7)))
summary(datgr)
LVBconstrainLmax = function(x, t0, logLmax, K) {
exp(logLmax)*(1-exp(-K*(x-t0)))
}
LVB.nlme = nlme(L ~ LVBconstrainLmax(Age, t0, logLmax, K), data=datgr, 
fixed= list(t0 ~ 1, logLmax ~ 1, K ~ 1), random= t0 + logLmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, logLmax=3.8, K=0.18)))
summary(LVB.nlme)
LVBabc.nlme = update(LVB.nlme, fixed= list(t0 ~ Sex, logLmax ~ Sex, K ~ Sex),
start=list(fixed=c(-0.44, 0, 0, 3.8, 0, 0, 0.18, 0, 0)), verbose=TRUE)
summary(LVBabc.nlme)
windows()
pairs(coef(LVB.nlme))
cleanup()
search()
# C:\JVA\Consult\Hansen\vonBgrowth\Musky_growth3 - JVA.R
# Load required libraries:
library(grid)
library(lattice)
library(stats)
library(nlme)
# Define the workspace:
# setwd("C:\\Users\\Public\\Documents\\Faust")
# Import the data into R under the object name datgr:
datgr=groupedData(L~Age|id, data=read.table("C:/JVA/Consult/Hansen/vonBgrowth/MuskyFMU.txt", header=TRUE, sep="\t"), 
labels=list(x="Age", y="Size"), units=list(x="(Years)", y="(inches)"))
datgr$Pop <- as.factor(datgr$Pop)
datgr$Sex <- as.factor(datgr$Sex)
# Visualise the data (ignored for now...):
# plot(datgr)
xyplot(L ~ Age | Sex, datgr)
# Declare growth functions:
LVBconstrainLmax = function(x, t0, logLmax, K) {
exp(logLmax)*(1-exp(-K*(x-t0)))
}
# Fit a LVB model by NLME. 
# If the model does not converge, try changing starting values:
LVB.nlme = nlme(L ~ LVBconstrainLmax(Age, t0, logLmax, K), data=datgr, 
fixed= list(t0 ~ 1, logLmax ~ 1, K ~ 1), random= t0 + logLmax + K ~ 1, groups= ~ id, 
start=list(fixed=c(t0=-0.41, logLmax=3.8, K=0.18)))
# Display results:
summary(LVB.nlme)
intervals(LVB.nlme)
anova(LVB.nlme)
head(coef(LVB.nlme))
co <- coef(LVB.nlme)
# These two plots are ignored for now...
# plot(LVB.nlme)
# plot(augPred(LVB.nlme, level=0:1))
# Compare LVB growth models between two (or more) groups:
LVB1.nlme = update(LVB.nlme, fixed= list(t0 ~ Sex, logLmax ~ Sex, K ~ Sex),
start=list(fixed=c(-0.44, 0, 0, 3.8, 0, 0, 0.18, 0, 0)), verbose=TRUE)
summary(LVB1.nlme)
# test for significant effect of Morph
anova(LVB.nlme, LVB1.nlme)
cleanup()
q()
# C:\JVA\Lamprey\ChemControl\Resistance\Boogaard\ReadBoogaard.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/"
myfiles <- c("1989-1990 combined tox data TFM sea lamprey.xls", 
"1997 1998 combined tox data TFM sea lamprey.xls", 
"2001-2003 combined tox data TFM sea lamprey.xls", 
"2009 combined tox data TFM sea lamprey.xls", 
"On-site tests-Ludington-- Final JVAmod.xls", 
"On-site tests-Canada JVAmod.xls")
startr <- c(6, 6, 6, 5, 6, 6, 1)
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
dat <- readWorksheet(wb, sheet=getSheets(wb)[1], startRow=startr[i])
names(dat) <- jvanames(names(dat))
dat$Folder <- "Boogaard"
dat$File <- myfiles[i]
dat$Row <- 1:dim(dat)[1]
datlist[[i]] <- dat
}
dat <- do.call(rbind.fill, datlist)
head(dat)
# remove rows with all missing data
dat1 <- dat[!is.na(dat$total), ]
# remove columns with all missing data
dat1 <- dat1[, c("date", "tank", "ph.nom", "ph.ave", "alk.nom", "alk.ave", "tfm", "dead", "total", "x.nic.nom", "x.nic.ave", "location", "note", 
"Folder", "File")]
# convert to numeric
dat1$alk.nom <- as.numeric(dat1$alk.nom)
dat1$alk.ave <- as.numeric(dat1$alk.ave)
# fill in zeroes for missing niclosamides
dat1$x.nic.nom[is.na(dat1$x.nic.nom)] <- 0
dat1$x.nic.ave[is.na(dat1$x.nic.ave)] <- 0
# look at notes
dat1[!is.na(dat1$note), ]
dat1[!is.na(dat1$location) & dat1$location=="Nunns Creek", ]
# eliminate two brown trout records
dat1[!is.na(dat1$location) & dat1$location=="Nunns Creek" & dat1$tank %in% 16:20, ]
dat1 <- dat1[!(!is.na(dat1$location) & dat1$location=="Nunns Creek" & dat1$tank %in% 16:20), ]
boogdat <- dat1
head(boogdat)
        # date tank ph.nom ph.ave alk.nom alk.ave  tfm dead total x.nic.nom x.nic.ave location note                                          file
# 1 1989-02-20    1    6.5   6.54      30      27 0.47   20    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 2 1989-02-20    2    6.5   6.54      30      27 0.38   20    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 3 1989-02-20    3    6.5   6.54      30      27 0.31   20    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 4 1989-02-20    4    6.5   6.54      30      27 0.26   19    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 5 1989-02-20    5    6.5   6.54      30      27 0.20   11    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
# 6 1989-02-20    6    6.5   6.54      30      27 0.17    2    20         0         0     <NA> <NA> 1989-1990 combined tox data TFM sea lamprey.xls
rm(mydir, myfiles, startr, datlist, i, wb, dat, dat1)
head(boogdat)
boogdat
plot(boogdat$tank)
plot(boogdat$tank, type="l")
locator()
boogdat[750:800, ]
a <- with(boogdat, mytable(date, tank))
dim(a)
apply(!is.na(a), 1, sum)
apply(a>1, 1, sum)
boogdat[boogdat$date=="1989-02-04", ]
a
boogdat <- with(boogdat, boogdat[order(date, ph.nom, alk.nom, tank), ])
dpa <- with(boogdat, paste(date, ph.nom, alk.nom))
boogdat$group <- cumsum(first(dpa))
head(boogdat)
boogdat
plot(boogdat$group)
plot(mytable(boogdat$group))
plot(as.numeric(mytable(boogdat$group)))
plot(sort(as.numeric(mytable(boogdat$group))))
a <- mytable(boogdat$group)
a[a>15]
boogdat[boogdat$group %in% names(a[a>15]), ]
boogdat[boogdat$group %in% names(a[a>15]), ]
with(boogdat, plot(group, tank))
a <- with(boogdat, table(group, tank))
apply(a>1, 1, sum)
mytable(apply(a>1, 1, sum))
sort(apply(a>1, 1, sum))
boogdat[boogdat$group %in% c(93, 97, 55, 72, 180), ]
boogdat <- with(boogdat, boogdat[order(date, ph.nom, alk.nom, x.nic.nom, tank), ])
dpa <- with(boogdat, paste(date, ph.nom, alk.nom, x.nic.nom))
boogdat$group <- cumsum(first(dpa))
a <- with(boogdat, table(group, tank))
rev(sort(apply(a>1, 1, sum)))
boogdat[boogdat$group %in% c(78, 226, 117), ]
boogdat <- with(boogdat, boogdat[order(date, ph.nom, alk.nom, x.nic.nom, location, tank), ])
dpa <- with(boogdat, paste(date, ph.nom, alk.nom, x.nic.nom, ))
boogdat$group <- cumsum(first(dpa))
a <- with(boogdat, table(group, tank))
rev(sort(apply(a>1, 1, sum)))
boogdat <- with(boogdat, boogdat[order(date, ph.nom, alk.nom, x.nic.nom, location, tank), ])
dpa <- with(boogdat, paste(date, ph.nom, alk.nom, x.nic.nom, location))
boogdat$group <- cumsum(first(dpa))
a <- with(boogdat, table(group, tank))
rev(sort(apply(a>1, 1, sum)))
boogdat[boogdat$group %in% c(232, 123), ]
# C:\JVA\Lamprey\ChemControl\Resistance\Boogaard\ReadBoogaard.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/Boogaard/"
myfiles <- c("1989-1990 combined tox data TFM sea lamprey.xls", 
"1997 1998 combined tox data TFM sea lamprey.xls", 
"2001-2003 combined tox data TFM sea lamprey.xls", 
"2009 combined tox data TFM sea lamprey.xls", 
"On-site tests-Ludington-- Final JVAmod.xls", 
"On-site tests-Canada JVAmod.xls")
startr <- c(6, 6, 6, 5, 6, 6, 1)
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
dat <- readWorksheet(wb, sheet=getSheets(wb)[1], startRow=startr[i])
names(dat) <- jvanames(names(dat))
dat$Folder <- "Boogaard"
dat$File <- myfiles[i]
dat$Row <- 1:dim(dat)[1]
datlist[[i]] <- dat
}
dat <- do.call(rbind.fill, datlist)
head(dat)
# remove rows with all missing data
dat1 <- dat[!is.na(dat$total), ]
# remove columns with all missing data
dat1 <- dat1[, c("date", "tank", "ph.nom", "ph.ave", "alk.nom", "alk.ave", "tfm", "dead", "total", "x.nic.nom", "x.nic.ave", "location", "note", 
"Folder", "File")]
# convert to numeric
dat1$alk.nom <- as.numeric(dat1$alk.nom)
dat1$alk.ave <- as.numeric(dat1$alk.ave)
# fill in zeroes for missing niclosamides
dat1$x.nic.nom[is.na(dat1$x.nic.nom)] <- 0
dat1$x.nic.ave[is.na(dat1$x.nic.ave)] <- 0
# look at notes
dat1[!is.na(dat1$note), ]
dat1[!is.na(dat1$location) & dat1$location=="Nunns Creek", ]
# eliminate two brown trout records
dat1[!is.na(dat1$location) & dat1$location=="Nunns Creek" & dat1$tank %in% 16:20, ]
dat1 <- dat1[!(!is.na(dat1$location) & dat1$location=="Nunns Creek" & dat1$tank %in% 16:20), ]
boogdat <- dat1
boogdat <- with(boogdat, boogdat[order(date, ph.nom, alk.nom, x.nic.nom, location, tank), ])
dpa <- with(boogdat, paste(date, ph.nom, alk.nom, x.nic.nom, location))
boogdat$group <- cumsum(first(dpa))
a <- with(boogdat, table(group, tank))
rev(sort(apply(a>1, 1, sum)))
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
# assign a new ID every time a new start date or a new concentration is entered
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
# fill in the blanks for the columns when a new concentration starts
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
filled <- data.frame(lapply(McGarrydat[, !sel], fill))
newconcrows <- is.na(McGarrydat$start.date) & !is.na(McGarrydat$conc.)
McGarrydat[newconcrows, !sel] <- filled[newconcrows, ]
head(McGarrydat)
rm(mydir, myfiles, datlist, i, wb, mysheets, sheetlist, j, dat)
fill
numvec <- c(NA, 1:5, NA, NA, NA, 10:12, NA)
numvec
length(numvec)
group <- rep(1:3, c(4, 4, 5))
first(group)
fill <- function(x, resetwhen=rep(FALSE, length(x)))
{
# fill in a vector of values
# assign to every NA or "" the last value for the vector
    y <- x
    last <- x[1]
    if(is.character(x)){
        for(i in 2:length(x))
            if((x[i]=="" | is.na(x[i])) & !resetwhen[i]) y[i] <- last else last <- x[i]
        } else {
        for(i in 2:length(x))
            if(is.na(x[i]) & !resetwhen[i]) y[i] <- last else last <- x[i]
        }
    y
}
fill(numvec)
fill(numvec, first(group))
#' Fill in Missing Values
#'
#' Fill in missing values in a vector, using the last recorded value.  
#' @param x A vector, can be character, numeric, or logical.
#' @param resetwhenA logical vector, the same length as \code{x}.
#' @return A vector the same length as \code{x}, with all NAs or ""s replace by the last value for the vector.
#' Note that and missing values at the beginning of the vector will not be replaced.
#' @export
#' @detailsSimilar to \code{\link[zoo]{na.locf}} in the \code{zoo} package, but works for "" in character vectors as well.
#' @examples 
#' numvec <- c(NA, 1:5, NA, NA, NA, 10:12, NA)
#' group <- rep(1:3, c(4, 4, 5))
#' fill(numvec)
#' fill(numvec, first(group))
#'
#' charvec <- c("", letters[1:5], "", "", "", letters[10:12], "")
#' fill(charvec)
fill <- function(x, resetwhen=rep(FALSE, length(x)))
{
# fill in a vector of values
# assign to every NA or "" the last value for the vector
    y <- x
    last <- x[1]
    if(is.character(x)){
        for(i in 2:length(x))
            if((x[i]=="" | is.na(x[i])) & !resetwhen[i]) y[i] <- last else last <- x[i]
        } else {
        for(i in 2:length(x))
            if(is.na(x[i]) & !resetwhen[i]) y[i] <- last else last <- x[i]
        }
    y
}
head(McGarrydat
)
# WITHIN A SHEET, fill in the blanks for most of the columns
McGarrydat <- with(McGarrydat, McGarrydat[order(File, Sheet, Row, ID), ])
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
filled <- data.frame(lapply(McGarrydat[, !sel], fill, first(McGarrydat$Sheet)))
filled
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
# assign a new ID every time a new start date or a new concentration is entered
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
# WITHIN A SHEET, fill in the blanks for most of the columns
McGarrydat <- with(McGarrydat, McGarrydat[order(File, Sheet, Row, ID), ])
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
McGarrydat[, !sel] <- data.frame(lapply(McGarrydat[, !sel], fill, first(McGarrydat$Sheet)))
McGarrydat <- with(McGarrydat, McGarrydat[order(File, Sheet, Row, ID), ])
# assign a unique group to each sheet, species and source of animals
sss <- with(McGarrydat, paste(Sheet, species, source.of.animals))
McGarrydat$group <- cumsum(first(sss))
McGarrydat
names(# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
# assign a new ID every time a new start date or a new concentration is entered
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
# WITHIN A SHEET, fill in the blanks for most of the columns
McGarrydat <- with(McGarrydat, McGarrydat[order(File, Sheet, Row, ID), ])
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
McGarrydat[, !sel] <- data.frame(lapply(McGarrydat[, !sel], fill, first(McGarrydat$Sheet)))
McGarrydat <- with(McGarrydat, McGarrydat[order(File, Sheet, Row, ID), ])
# assign a unique group to each sheet, species and source of animals
sss <- with(McGarrydat, paste(Sheet, species, source.of.animals))
McGarrydat$group <- cumsum(first(sss))
names(McGarrydat)
McGarrydat[, c(20:28, 31:36)]
# C:\JVA\Lamprey\ChemControl\Resistance\McGarry\ReadMcGarry.r
library(plyr)
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/McGarry/"
# all xlsx files in directory
myfiles <- list.files(mydir)[grep(".xlsx$", list.files(mydir))]
# exclude files with "old" in their names
myfiles <- myfiles[-grep("old", myfiles)]
datlist <- vector("list", length(myfiles))
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
mysheets <- getSheets(wb)
sheetlist <- vector("list", length(mysheets))
for(j in seq_along(mysheets)) {
dat <- readWorksheet(wb, sheet=getSheets(wb)[j], startRow=1)
names(dat) <- jvanames(names(dat))
dat$Folder <- "McGarry"
dat$File <- myfiles[i]
dat$Sheet <- mysheets[j]
dat$Row <- 1:dim(dat)[1]
sheetlist[[j]] <- dat
}
datlist[[i]] <- do.call(rbind.fill, sheetlist)
}
if(FALSE) {
# try to figure out errors
a <- lapply(datlist, function(df) unique(c(df$start.date[!is.na(df$start.date)], df$df$end.date[!is.na(df$end.date)])) )
b <- as.Date(unlist(lapply(a, as.character)))
b2 <- unlist(a)
look <- do.call(rbind.fill, datlist[1:26])
}
dat <- do.call(rbind.fill, datlist)
# convert to numeric
dat$dead <- as.numeric(dat$dead)
McGarrydat <- dat
# a blank line was left between many entries
McGarrydat <- McGarrydat[!is.na(McGarrydat$check.time), ]
# assign a new ID every time a new start date or a new concentration is entered
McGarrydat$ID <- cumsum(!is.na(McGarrydat$start.date) | !is.na(McGarrydat$conc.))
combine.comments <- function(df, commname) {
# combine general comments for ID into one field if they are spread across several rows
sel <- !is.na(df[, commname])
combined <- tapply(df[sel, commname], df$ID[sel], paste, collapse="; ")
newcom <- rep("", dim(df)[1])
newcom[match(names(combined), df$ID)] <- combined
newcom
}
McGarrydat$general.comment..regarding.the.whole.test. <- combine.comments(McGarrydat, "general.comment..regarding.the.whole.test.")
# WITHIN A SHEET, fill in the blanks for most of the columns
McGarrydat <- with(McGarrydat, McGarrydat[order(File, Sheet, Row, ID), ])
leavethese <- c("discomfort", "ill", "dead", "specific.comment..regarding.just.the.corresponding.line.of.data.")
sel <- names(McGarrydat) %in% leavethese
McGarrydat[, !sel] <- data.frame(lapply(McGarrydat[, !sel], fill, first(McGarrydat$Sheet)))
McGarrydat <- with(McGarrydat, McGarrydat[order(File, Sheet, Row, ID), ])
# assign a unique group to each sheet, species and source of animals
sss <- with(McGarrydat, paste(Sheet, species, source.of.animals))
McGarrydat$group <- cumsum(first(sss))
head(McGarrydat)
rm(mydir, myfiles, datlist, i, wb, mysheets, sheetlist, j, dat)
# C:\JVA\Lamprey\ChemControl\Resistance\Nowicki\ReadNowicki.r
# Getting Access data into R
# http://sandymuspratt.blogspot.com/2013/01/getting-access-data-into-r.html
# I couldn't get it to work, so I just exported each table individually to an Excel file, and I will work with them instead
# ALSO, I had to save the Main table as a csv file to read it into R 
mydir <- "C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/"
# xlsx files in directory
myfiles <- c("_Chemicals.xlsx", "_Formulations.xlsx", "_Labs.xlsx", "_Lakes.xlsx", "_Species.xlsx", "_Streams.xlsx", "_Test_Types.xlsx")
datlist <- vector("list", length(myfiles)+2)
for(i in seq_along(myfiles)) {
wb <- loadWorkbook(paste0(mydir, myfiles[i]))
dat <- readWorksheet(wb, sheet=getSheets(wb)[1])
rm(wb)
names(dat) <- jvanames(names(dat))
datlist[[i]] <- dat
}
datlist[[length(myfiles)+1]] <- read.csv(paste0(mydir, "CheckTimes.csv"), as.is=TRUE)
datlist[[length(myfiles)+2]] <- read.csv(paste0(mydir, "Main.csv"), as.is=TRUE)
names(datlist) <- c("chemicals", "formulations", "labs", "lakes", "species", "streams", "testtypes", "checktimes", "main")
datlist$main$Folder <- "Nowicki"
datlist$main$File <- "Toxicity Data.accdb"
Nowdat <- datlist
rm(mydir, myfiles, datlist, i, dat)
lapply(Nowdat, head, 3)
Nowdat$main
dput(names(Nowdat$main))
q()
cleanup()
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
# keepsub <- c("ID", "Test_Sick", "Test_Dead", 
# "Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
# "concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
keepsub <- c("ID", "Test_Sick", "Test_Dead", 
"concentration_t", "pH_t", "DO_t", "water_temp_t", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
# Sub1$Conc_Target <- Main1$Concentration[sm]
# Sub1$pH_Target <- Main1$pH[sm]
# Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
# Sub2$Conc_Target <- Main1$Concentration[sm]
# Sub2$pH_Target <- Main1$pH[sm]
# Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
# m.sub$concentration_t <- fill(m.sub$concentration_t)
# m.sub$Test_Species <- fill(m.sub$Test_Species)
# m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
dt1 <- as.numeric(Slaghtdat$Start_Time)
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
# k.sub$concentration_t <- fill(k.sub$concentration_t)
# k.sub$Test_Species <- fill(k.sub$Test_Species)
# k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
dt1 <- as.numeric(Robdat$Start_Time)
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- hrs
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
# r.sub$Test_Species <- fill(r.sub$Test_Species)
# r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
# when a value is provided in main for conc, ph, or alk ... copy this to sub as the "target"
sm <- match(all.sub$ID, all.main$ID)
all.sub$Conc_Target <- all.main$Concentration[sm]
all.sub$pH_Target <- all.main$pH[sm]
all.sub$Alk_Target <- all.main$Total_Alkalinity[sm]
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
look <- all.sub[all.sub$ID %in% setdiff(all.sub$ID, all.main$ID), ]
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\AnalyzeRaw.r
library(lubridate)
library(LW1949)
library(lattice)
load("C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(all.main$Folder)
with(all.main, tapply(ID, Folder, range))
all.main$Year <- year(all.main$Start_Date)
all.sub$Year <- all.main$Year[match(all.sub$ID, all.main$ID)]
summary(all.main)
summary(all.main)
# C:\JVA\Lamprey\ChemControl\Resistance\Analysis\ReadRawData.r
library(lubridate)
# read in all the raw data
source("C:/JVA/Lamprey/ChemControl/Resistance/Nowicki/ReadNowicki.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/McGarry/ReadMcGarry.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Slaght/ReadSlaght.r")
source("C:/JVA/Lamprey/ChemControl/Resistance/Robertson/ReadRobertson.r")
# adjust IDs
McGarrydat$ID <- McGarrydat$ID + max(Nowdat$main$ID)
Slaghtdat$ID <- Slaghtdat$ID + max(McGarrydat$ID)
Robdat$ID <- Robdat$ID + max(Slaghtdat$ID)
# use Nowdat as comparison
# lapply(Nowdat, head, 2)
# head(McGarrydat, 2)
# head(Slaghtdat, 2)
# head(Robdat, 2)
n <- names(Nowdat$main)
c <- names(Nowdat$checktimes)
m <- names(McGarrydat)
k <- names(Slaghtdat)
r <- names(Robdat)
a <- unique(c(m, k, r))
# added to main
# c("acc..no.", "aerated.", "cond.", "cond..unit", "water.chem..date", "file", "Row", "water")
mainnames <- matrix(c(
"chemical", "Chemical",
"general.comment..regarding.the.whole.test.", "Comment_ID",
"Comments", "Comment_ID",
"note", "Comment_ID",
"formulation", "Formulation", 
"lab", "Lab", 
"lake", "Lake", 
"location", "Location", 
"total.no..tested", "Number_Tested", 
"Number_Tested_Species_1", "Number_Tested", 
"Number_Tested_Species_2", "Number_Tested", 
"tfm", "Concentration",
"ph", "pH", 
"ph.ave", "pH", 
"start.date", "Start_Date", 
"date", "Start_Date",
"start.time", "Start_Time", 
"water.code", "Stream", 
"test.no.", "Test_Number", 
"tank", "Test_Number", 
"species", "Test_Species", 
"Test_Species_1", "Test_Species", 
"Test_Species_2", "Test_Species", 
"source.of.animals", "Test_Source", 
"Test_Species_1_Source", "Test_Source", 
"Test_Species_2_Source", "Test_Source", 
"test.type", "Test_Type", 
"alk.", "Total_Alkalinity", 
"alk.ave", "Total_Alkalinity", 
"temp.", "Water_Temp", 
"temp..unit", "Water_Temp_Unit",
"acc..no.", "Acc_No",
"aerated.", "Aerated", 
"cond.", "Conductivity",
"cond..unit", "Conductivity_Unit",
"water.chem..date", "Water_Chem_Date",
"water", "Water_Name"
), ncol=2, byrow=TRUE)
# added to sub
# "specific.comment..regarding.just.the.corresponding.line.of.data."
subnames <- matrix(c(
"check.time", "Hours", 
"conc.", "concentration_t", 
"dead", "Test_Dead", 
"Test_Species_1_Dead", "Test_Dead", 
"Test_Species_2_Dead", "Test_Dead", 
"ill", "Test_Sick",
"Test_Species_1_Sick", "Test_Sick",
"Test_Species_2_Sick", "Test_Sick",
"specific.comment..regarding.just.the.corresponding.line.of.data.", "Comment_Tank"
), ncol=2, byrow=TRUE)
n[is.na(match(n, mainnames[, 2]))]
c[is.na(match(c, subnames[, 2]))]
sort(a[is.na(match(a, mainnames[, 1])) & is.na(match(a, subnames[, 1]))])
look <- function(varname) {
if(varname %in% m) print(unique(McGarrydat[, varname]))
if(varname %in% k) print(unique(Slaghtdat[, varname]))
if(varname %in% r) print(unique(Robdat[, varname]))
invisible()
}
look("discomfort")
rm(n, c, m, k, r, a, look)
# calculate Duration
mmax <- tapply(McGarrydat$check.time, McGarrydat$ID, max)
indx <- tapply(McGarrydat$check.time, McGarrydat$ID)
McGarrydat$Duration <- as.numeric(mmax[indx])
Slaghtdat$Duration <- (as.numeric(Slaghtdat$end.date) + as.numeric(Slaghtdat$end.time) - 
(as.numeric(Slaghtdat$start.date) + as.numeric(Slaghtdat$start.time)))/60/60
mmax <- tapply(Robdat$check.time, Robdat$ID, max, na.rm=TRUE)
indx <- tapply(Robdat$check.time, Robdat$ID)
maxtime <- mmax[indx]
Robdat$Duration <- (as.numeric(maxtime) - as.numeric(Robdat$start.time))/60/60
rm(mmax, indx, maxtime)
# split up Nowicki data by species
keepmain <- c("ID", "group", "Test_Type", "Lake", "Stream", "Water_Not_Lake_Or_Stream", 
"Location", "Lab", "Start_Date", "Start_Time", "Test_Number", 
"Chemical", "Formulation", "Concentration", "Water_Temp", "Water_Temp_Unit", "pH", 
"Total_Alkalinity", "Comment_ID", "Burrowed", "Duration", "Folder", "File")
# keepsub <- c("ID", "Test_Sick", "Test_Dead", 
# "Conc_Target", "concentration_t", "pH_Target", "pH_t", "DO_t", "water_temp_t", "Alk_Target", "alkalinity_t", 
# "concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
keepsub <- c("ID", "group", "Test_Sick", "Test_Dead", 
"concentration_t", "pH_t", "DO_t", "water_temp_t", "alkalinity_t", 
"concentrationB_t", "Species", "Number_Tested", "Test_Source", "Check_Date", "Check_Time", "Hours")
# first pull off all the species 1 data
Main1 <- Nowdat$main
# Main1 <- Main1[, !(names(Main1) %in% c("Test_Species_2", "Number_Tested_Species_2", "Test_Species_2_Source"))]
Main1$Start_Date <- sapply(strsplit(Main1$Start_Date, " "), "[", 1)
Main1$Start_Time <- sapply(strsplit(Main1$Start_Time, " "), "[", 2)
mdt <- strptime(paste(Main1$Start_Date, Main1$Start_Time), "%m/%d/%Y %H:%M:%S")
ids1 <- Main1$ID[subdex(Main1, Number_Tested_Species_1>0)]
Sub1 <- Nowdat$checktimes
Sub1 <- Sub1[Sub1$ID %in% ids1, !(names(Sub1) %in% c("Test_Species_2_Sick", "Test_Species_2_Dead"))]
Sub1$Check_Date <- sapply(strsplit(Sub1$Check_Date, " "), "[", 1)
Sub1$Check_Time <- sapply(strsplit(Sub1$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub1$Check_Date, Sub1$Check_Time), "%m/%d/%Y %H:%M:%S")
sm <- match(Sub1$ID, Main1$ID)
Sub1$Species <- Main1$Test_Species_1[sm]
Sub1$Number_Tested <- Main1$Number_Tested_Species_1[sm]
Sub1$Test_Source <- Main1$Test_Species_1_Source[sm]
Sub1$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
# Sub1$Conc_Target <- Main1$Concentration[sm]
# Sub1$pH_Target <- Main1$pH[sm]
# Sub1$Alk_Target <- Main1$Total_Alkalinity[sm]
names(Sub1) <- recode(names(Sub1), subnames[, 1], subnames[, 2])
Sub1 <- Sub1[, keepsub]
# then pull off all the species 2 data
# Main2 <- Nowdat$main
# Main2 <- Main2[!is.na(Main2$Test_Species_2), !(names(Main2) %in% c("Test_Species_1", "Number_Tested_Species_1", "Test_Species_1_Source"))]
# mdt <- strptime(paste(Main2$Start_Date, Main2$Start_Time), "%m/%d/%Y %H:%M")
ids2 <- Main1$ID[subdex(Main1, Number_Tested_Species_2>0)]
Sub2 <- Nowdat$checktimes
Sub2 <- Sub2[Sub2$ID %in% ids2, !(names(Sub2) %in% c("Test_Species_1_Sick", "Test_Species_1_Dead"))]
Sub2$Check_Date <- sapply(strsplit(Sub2$Check_Date, " "), "[", 1)
Sub2$Check_Time <- sapply(strsplit(Sub2$Check_Time, " "), "[", 2)
sdt <- strptime(paste(Sub2$Check_Date, Sub2$Check_Time), "%m/%d/%Y %H:%M")
sm <- match(Sub2$ID, Main1$ID)
Sub2$Species <- Main1$Test_Species_2[sm]
Sub2$Number_Tested <- Main1$Number_Tested_Species_2[sm]
Sub2$Test_Source <- Main1$Test_Species_2_Source[sm]
Sub2$Hours <- (as.numeric(sdt) - as.numeric(mdt)[sm])/60/60
# Sub2$Conc_Target <- Main1$Concentration[sm]
# Sub2$pH_Target <- Main1$pH[sm]
# Sub2$Alk_Target <- Main1$Total_Alkalinity[sm]
# names(Main2) <- recode(names(Main2), mainnames[, 1], mainnames[, 2])
# Main2 <- Main2[, keepmain]
names(Sub2) <- recode(names(Sub2), subnames[, 1], subnames[, 2])
Sub2 <- Sub2[, keepsub]
#all.equal(Main1, Main2)
names(Main1) <- recode(names(Main1), mainnames[, 1], mainnames[, 2])
Main1 <- Main1[, keepmain]
Main <- Main1
Sub <- rbind(Sub1, Sub2)
Main$Chemical <- Nowdat$chemicals$chemical.desc[match(Main$Chemical, Nowdat$chemicals$chemical)]
Main$Formulation <- Nowdat$formulations$formulation.desc[match(Main$Formulation, Nowdat$formulations$formulation)]
Main$Lab <- Nowdat$labs$lab.name[match(Main$Lab, Nowdat$labs$lab)]
Main$Test_Type <- Nowdat$testtypes$test.type.desc[match(Main$Test_Type, Nowdat$testtypes$test.type)]
Main$Start_Date <- as.Date(Main$Start_Date, "%m/%d/%Y")
head(Main)
head(Sub)
rm(keepmain, keepsub, Main1, mdt, Sub1, sdt, sm, Sub2)
a <- Nowdat$main
b <- Nowdat$checktimes
selcols <- c("ID", "Test_Species_1", "Number_Tested_Species_1", "Test_Species_2", "Number_Tested_Species_2", "pH", "Total_Alkalinity", "Comments")
nshowme <- function(id, selcols=selcols) {
print(a[a$ID==id, selcols])
print(b[b$ID==id, ])
}
# The Nowicki data has many records entered as 0 when they should be left blank
# For simplicity, I will ignore concentrations of zero in the analysis
sel <- subdex(a, Concentration < 0.000001)
look1 <- tapply(a$Concentration, list(a$ID, sel), mean, na.rm=TRUE)
sel <- subdex(b, concentration_t < 0.000001)
look2 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
m <- match(dimnames(look2)[[1]], dimnames(look1)[[1]])
plot(look1[m, 1], look2[, 1])
sel <- !is.na(b$concentration_t)
look3 <- tapply(b$concentration_t, list(b$ID, sel), mean, na.rm=TRUE)
ids <- dimnames(look3)[[1]][!is.na(look3[, 2]) & look3[, 2] < 0.000001]
a$Concentration[a$ID %in% ids]
a$ID[a$ID %in% ids & is.na(a$Concentration)]
# number of non missing concentrations in sub by ID
nconc <- tapply(!is.na(b$concentration_t), b$ID, sum)
nmiss <- tapply(is.na(b$concentration_t), b$ID, sum)
mat <- match(a$ID, names(nconc))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nconclong <- nconc[mat]
mat <- match(a$ID, names(nmiss))
# there are a bunch of records in main that have no matching record in sub
a$ID[is.na(mat)]
nmisslong <- nmiss[mat]
mytable(nconclong, is.na(a$Concentration))
mytable(nmisslong, is.na(a$Concentration))
mytable(nconclong, nmisslong, is.na(a$Concentration))
# concentrations filled in in main, and partial filled in concentrations in sub
sel <- !is.na(a$Concentration) & !is.na(nconclong) & nconclong > 0 & !is.na(nmisslong) & nmisslong > 0
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong == 1
a$ID[sel]
# concentrations NOT filled in in main, and partial filled in concentrations in sub, more than ONE filled in
sel <- is.na(a$Concentration) & !is.na(nmisslong) & nmisslong > 0 & !is.na(nconclong) & nconclong > 1
a$ID[sel]
# split up others into a main and a sub
# eliminate   c("alk..unit", "conc..unit", "container", "cumulative..dead", "cumulative..ill", "discomfort", "end.date", "end.time")
names(McGarrydat) <- recode(names(McGarrydat), mainnames[, 1], mainnames[, 2])
names(McGarrydat) <- recode(names(McGarrydat), subnames[, 1], subnames[, 2])
m.main <- McGarrydat[!is.na(McGarrydat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Conductivity", "Conductivity_Unit", "Test_Number", "pH", "Total_Alkalinity", 
"Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
a <- m.main$Start_Time
a1 <- floor(a/100)
a2 <- a - 100*a1
m.main$Start_Date <- as.Date(m.main$Start_Date)
m.main$Start_Time <- paste(substring(100+a1, 2), substring(100+a2, 2), sep=":")
m.sub <- McGarrydat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours", 
"Test_Sick", "Test_Dead", "Comment_Tank", "ID", "Row")]
# m.sub$concentration_t <- fill(m.sub$concentration_t)
# m.sub$Test_Species <- fill(m.sub$Test_Species)
# m.sub$Number_Tested  <- fill(m.sub$Number_Tested)
m.sub$Test_Sick[is.na(m.sub$Test_Sick)] <- 0
m.sub$Test_Dead[is.na(m.sub$Test_Dead)] <- 0
names(Slaghtdat) <- recode(names(Slaghtdat), mainnames[, 1], mainnames[, 2])
names(Slaghtdat) <- recode(names(Slaghtdat), subnames[, 1], subnames[, 2])
dt1 <- as.numeric(Slaghtdat$Start_Time)
dt2 <- as.numeric(strptime(paste("1899-12-31", substring(as.character(Slaghtdat$Hours + 10000), 2)), "%Y-%m-%d %H%M"))
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Slaghtdat$Hours <- hrs
k.main <- Slaghtdat[!is.na(Slaghtdat$Start_Date), c("Test_Type", "Water_Name", "Location", "Lab", "Acc_No", "Start_Date", 
"Start_Time", "Water_Temp", "Water_Temp_Unit", 
"Test_Number", "pH", "Total_Alkalinity", "Chemical", 
"Formulation", "Folder", "File", "Sheet", "Row", "Aerated", "Comment_ID", "ID", "Duration")]
k.main$Start_Date <- as.Date(k.main$Start_Date)
k.main$Start_Time <- format(k.main$Start_Time, "%H:%M")
k.sub <- Slaghtdat[, c("concentration_t", "Test_Source", "Test_Species", "Number_Tested", "Hours",  
"Comment_Tank", "Test_Sick", "Test_Dead", "ID", "Row")]
# k.sub$concentration_t <- fill(k.sub$concentration_t)
# k.sub$Test_Species <- fill(k.sub$Test_Species)
# k.sub$Number_Tested  <- fill(k.sub$Number_Tested)
k.sub$Test_Sick[is.na(k.sub$Test_Sick)] <- 0
k.sub$Test_Dead[is.na(k.sub$Test_Dead)] <- 0
names(Robdat) <- recode(names(Robdat), mainnames[, 1], mainnames[, 2])
names(Robdat) <- recode(names(Robdat), subnames[, 1], subnames[, 2])
dt1 <- as.numeric(Robdat$Start_Time)
dt2 <- as.numeric(Robdat$Hours)
hrs <- (dt2-dt1)/60/60
sel <- subdex(hrs, hrs<0)
hrs[sel] <- hrs[sel] + 24
Robdat$Hours <- hrs
r.main <- Robdat[!is.na(Robdat$Start_Date), c("Test_Type", "Lake", "Stream", "Water_Name", "Location", "Start_Date", 
"Start_Time", "Water_Chem_Date", "Water_Temp", "Water_Temp_Unit", 
"pH", "Total_Alkalinity", "Chemical", "Formulation", "Comment_ID", "Folder", "File", "Sheet", "Row", "ID", "Duration")]
r.main$Lake <- recode(r.main$Lake, c("S", "H", "NYO"), c(1, 3, 5))
r.main$Start_Date <- as.Date(r.main$Start_Date)
r.main$Start_Time <- format(r.main$Start_Time, "%H:%M")
r.main$Water_Chem_Date <- as.Date(r.main$Water_Chem_Date)
r.sub <- Robdat[, c("concentration_t", "Test_Species", "Number_Tested", 
"Hours", "Test_Sick", "Test_Dead", "Comment_Tank", "Row", "ID")]
# r.sub$Test_Species <- fill(r.sub$Test_Species)
# r.sub$Number_Tested  <- fill(r.sub$Number_Tested)
r.sub$Test_Sick[is.na(r.sub$Test_Sick)] <- 0
r.sub$Test_Dead[is.na(r.sub$Test_Dead)] <- 0
rm(a, a1, a2, dt1, dt2, hrs, mainnames, subnames)
look <- function(df, id) {
print(df[df$ID %in% id, ])
}
b <- with(k.sub, k.sub$ID[!is.na(Test_Species) & is.na(Number_Tested)])
look(k.main, b)
look(k.sub, b)
rm(look)
a <- merge(
cbind(names=names(Main), nclass=sapply(lapply(Main, class), "[", 1)),
cbind(names=names(m.main), mclass=sapply(lapply(m.main, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.main), kclass=sapply(lapply(k.main, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.main), rclass=sapply(lapply(r.main, class), "[", 1)), all=TRUE)
c
a <- merge(
cbind(names=names(Sub), nclass=sapply(lapply(Sub, class), "[", 1)),
cbind(names=names(m.sub), mclass=sapply(lapply(m.sub, class), "[", 1)), all=TRUE)
b <- merge(a,
cbind(names=names(k.sub), kclass=sapply(lapply(k.sub, class), "[", 1)), all=TRUE)
c <- merge(b,
cbind(names=names(r.sub), rclass=sapply(lapply(r.sub, class), "[", 1)), all=TRUE)
c
rm(a, b, c)
all.main <- rbind.fill(Main, m.main, k.main, r.main)
all.sub <- rbind.fill(Sub, m.sub, k.sub, r.sub)
# when a value is provided in main for conc, ph, or alk ... copy this to sub as the "target"
sm <- match(all.sub$ID, all.main$ID)
all.sub$Conc_Target <- all.main$Concentration[sm]
all.sub$pH_Target <- all.main$pH[sm]
all.sub$Alk_Target <- all.main$Total_Alkalinity[sm]
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
look <- all.sub[all.sub$ID %in% setdiff(all.sub$ID, all.main$ID), ]
####################
# need to revisit all NOWICKI comments and change them from general to specific as needed
# Urgh - there are 510 unique comments in NOWICKI ... I'm just going to leave them in general for now
####################
attach(all.main)
# fix Aerated
unique(Aerated)
all.main$Aerated <- recode(Aerated, c("aerated", "aeraated", "Aerated"), c("Yes", "Yes", "Yes"))
all.main$Aerated[Test_Type=="Static Aerated"] <- "Yes"
nota1 <- grep("no(n|t)( |-)aer", Comment_ID, ignore.case=TRUE)
nota2 <- grep("no aer", Comment_ID, ignore.case=TRUE)
nota3 <- grep("non- aer", Comment_ID, ignore.case=TRUE)
nota4 <- grep("unaer", Comment_ID, ignore.case=TRUE)
nota <- unique(c(nota1, nota2, nota3, nota4))
unique(Comment_ID[nota])
all.main$Aerated[nota] <- "No"
parta1 <- grep("Lost power to the trailer", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta1] <- "Partial"
# there was only the 10:00 time for this record
parta2 <- grep("Air was off at 1000", Comment_ID, ignore.case=TRUE)
all.main$Aerated[parta2] <- "Partial"
# some notes refer only to 24 hour test, not all tests ... so change aeration to yes in general, then add specific comment to that ID in all.sub
sela1 <- grep("24 H data not valid, power was out between 12-24H", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela1] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela1])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela1]) & all.sub$Hours > 13] <- "24 H data not valid, power was out between 12-24H time period, no aeration"
sela2 <- grep("aerated, no overnight aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela2] <- "Yes"
mytable(all.sub$Hours[all.sub$ID %in% unique(ID[sela2])])
all.sub$Comment_Tank[all.sub$ID %in% unique(ID[sela2]) & all.sub$Hours > 13] <- "aerated, no overnight aeration"
# no records entered after 1617
#sela3 <- grep("2 trout dead due to airstone left out of jar(1617)", Comment_ID, ignore.case=TRUE)
sela3 <- grep("2 trout dead due to airstone left out of jar", Comment_ID, ignore.case=TRUE)
all.main$Aerated[sela3] <- "Yes"
assa <- grep("Assumed to have aeration", Comment_ID, ignore.case=TRUE)
all.main$Aerated[assa] <- "Assumed"
alla <- grep("aer", Comment_ID, ignore.case=TRUE)
yesa <- alla[!(alla %in% c(nota, parta1, parta2, sela1, sela2, sela3, assa))]
all.main$Aerated[yesa] <- "Yes"
unique(all.main$Aerated)
a <- split(all.main, all.main$Aerated)
lapply(a, function(x) unique(x$Comment_ID))
lapply(a, function(x) unique(x$Test_Type))
# fix Conductivity_Unit
unique(Conductivity_Unit)
all.main$Conductivity_Unit <- recode(Conductivity_Unit, c("at 20C", "at 25C", "at 20c", "At 20C"), c("@20C", "@25C", "@20C", "@20C"))
unique(all.main$Conductivity_Unit)
# fix Water_Name
unique(Water_Name)
all.main$Water_Name[subdex(all.main, Water_Name=="lake Huron")] <- "Lake Huron"
unique(all.main$Water_Name)
# fix Duration
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# error in Nowicki Duration
all.main$Duration[!is.na(Duration) & Duration==224] <- 24
Duration[subdex(all.main, Duration<1 | Duration > 35)]
# fix Water_Temp_Unit
mytable(Water_Temp > 40, Water_Temp_Unit)
all.main$Water_Temp_Unit <- recode(Water_Temp_Unit, "", NA)
all.main$Water_Temp_Unit[subdex(all.main, Water_Temp > 40)] <- "F"
mytable(all.main$Water_Temp > 40, all.main$Water_Temp_Unit)
# fix Concentration
# Concentration in main table indicates targeted concentration for Nowicki
# ask ... what is the meaning of concentration in the main table???
look <- ID[!is.na(Concentration) & Concentration>100]
all.sub[all.sub$ID %in% look, ]
all.main[ID %in% look, ]
all.main[ID %in% look, c("ID", "Concentration")]
# fix Formulation
mytable(Formulation)
all.main$Formulation <- recode(Formulation, c("Hoeschst 37.6%", "Maumee 30", "Maumee 30% "), c("Hoechst 37.6%", "Maumee 30%", "Maumee 30%"))
mytable(all.main$Formulation)
# fix Chemical
mytable(Chemical)
fixit <- data.frame(
before = c("TFM+Bayuscide", "TFM+Bayluscide", "TFM + Bayer (.5%)-Mqt", "TFM + 0.5%Bayluscide", "TFM+0.5% Bayluscide", 
"TFM + Bayer (.8%)-Mqt", "TFM+0.8% Baylusicde", "TFM + Bayer (1%)-Mqt", "TFM + Bayer (1%)", "TFM+1.0% Bayluscide", "TFM + 1% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1% Niclosamide", "TFM + 1.5% Niclosamide", "TFM + Bayer (2%)", "TFM + Bayer (2%)-HB", "TFM + Bayer (2%)-Mqt"), 
after = c("TFM + Bayluscide", "TFM + Bayluscide", "TFM + 0.5% Bayluscide (Mqt)", "TFM + 0.5% Bayluscide", "TFM + 0.5% Bayluscide", "TFM + 0.8% Bayluscide (Mqt)", 
"TFM + 0.8% Bayluscide", "TFM + 1.0% Bayluscide (Mqt)", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", "TFM + 1.0% Bayluscide", 
"TFM + 1.0% Bayluscide", "TFM + 1.5% Bayluscide", "TFM + 2.0% Bayluscide", "TFM + 2.0% Bayluscide (HB)", "TFM + 2.0% Bayluscide (Mqt)")
)
all.main$Chemical <- recode(Chemical, fixit$before, fixit$after)
mytable(all.main$Chemical)
# fix Lab
unique(all.main$Lab)
all.main$Lab <- recode(Lab, c("Mobile Lab 2", "Moblie Lab 2", "Hammond bay", "Hmmond Bay"), 
c("Mobile Lab. No. 2", "Mobile Lab. No. 2", "Hammond Bay", "Hammond Bay"))
unique(Lab)
# fix Test_Type
unique(Test_Type)
all.main$Test_Type <- recode(Test_Type, c("Flow", "Flow through", "Flow Through", "static", "Static Aerated"), 
c("Flow Thru", "Flow Thru", "Flow Thru", "Static", "Static"))
unique(all.main$Test_Type)
detach(all.main)
attach(all.main)
year <- year(all.main$Start_Date)
allyears <- min(year):max(year)
mt <- mytable(year, paste(Test_Type, Aerated))
mt <- mytable(year, Test_Type)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
xlabs <- rep("", dim(mt2)[2])
sel <- substring(allyears, 4, 4) %in% c(0, 5)
xlabs[sel] <- substring(allyears, 3, 4)[sel]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Test Type")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
mt <- mytable(year, Folder)
mt2 <- t(mt[, order(apply(mt, 2, sum))])
mt2 <- mt2[, match(allyears, colnames(mt2))]
windows(w=6.5, h=4)
par(mar=c(3, 5, 1, 1))
a <- barplot(mt2, col=blindcolz[-1], las=1, names.arg=rep("", dim(mt2)[2]), xlab="", ylab="")
legend("topright", rev(rownames(mt2)), fill=rev(blindcolz[-1][1:dim(mt2)[1]]), title="Source")
mtext(xlabs, at=a, side=1)
mtext("Year", side=1, line=2)
mtext("Number of tests", side=2, line=4)
detach(all.main)
showme <- function(id) {
print(all.main[all.main$ID==id, ])
print(all.sub[all.sub$ID==id, ])
}
attach(all.sub)
### fix species names and codes
look <- function(str) {
sel <- stringin(str, Nowdat$species$species.name)
print(Nowdat$species[Nowdat$species$species.name %in% sel, ])
}
dput(sort(unique(Test_Species)))
entered <- c("Black Bullhead", "Bullhead", "Walleye", "Brown Trout", "Rainbow Trout", "RBT", 
"sea lamprey", "Sea lamprey", "Sea Lamprey", "sea lamprey ", "Sea Lamprey ", "SL")
codes <- c(100, 99, 122, 24, 27, 27, 2, 2, 2, 2, 2, 2)
newcodes <- recode(all.sub$Test_Species, entered, codes)
sel <- !is.na(all.sub$Test_Species)
all.sub$Species[sel] <- newcodes[sel]
all.sub$Test_Species <- Nowdat$species$species.name[match(all.sub$Species, Nowdat$species$species)]
# get rid of observations with a missing Number_Tested
unique(ID[is.na(Number_Tested)])
# 12805 12800 12814 14036
showme(12800)
rid <- is.na(Number_Tested)
# that also fixed the missing Hours
unique(ID[is.na(Hours)])
# 12805 12800 12814 14036
showme(12800)
# find records with missing concentration NOT from Nowicki
ids <- unique(ID[is.na(concentration_t)])
all.main$ID[all.main$ID %in% ids & all.main$Folder != "Nowicki"]
mytable(all.main$Folder, all.main$ID %in% ids)
ids <- unique(ID[is.na(concentration_t) & Species==2])
mytable(all.main$Chemical, all.main$ID %in% ids, is.na(all.main$Concentration))
sel <- all.main$Chemical=="TFM" & all.main$ID %in% ids & is.na(all.main$Concentration)
detach(all.sub)
dim(all.main)
dim(all.sub)
length(setdiff(all.sub$ID, all.main$ID))
save(list=c("all.main", "all.sub"), file="C:/JVA/Lamprey/ChemControl/Resistance/Analysis/RawData.RData")
mytable(round(all.sub$Hours, -1), all.main$Folder[match(all.sub$ID, all.main$ID)])
fill
library(jvamisc)
fill
library("devtools")
devtools::install_github("JVAdams/jvamisc")
library(jvamisc)
fill
cleanup()
q()
pkgin("LW1949")
pkgman("LW1949")
?cheat
pkgup("jvamisc")
q()
