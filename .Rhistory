# C:\JVA\Consult\Yule\CiscoMorpho\CiscoMorph.r
# bring in functions
source("C:/JVA/Consult/Yule/CiscoMorpho/CiscoMorphFunctions.r")
library(fpc)
library(rpart)
library(rpart.plot)
wb <- loadWorkbook("C:/JVA/Consult/Yule/CiscoMorpho/Cisco size-corrected residuals FINAL.xls")
dat1 <- readWorksheet(wb, sheet=getSheets(wb)[1], startRow=1)
dat1$LS <- paste(substring(dat1$LAKE, 1, 1), dat1$SITE, sep=" - ")
wb <- loadWorkbook("C:/JVA/Consult/Yule/CiscoMorpho/FISH MORPHOMETRICS with total lengths RAW Truss measurements.xlsx")
datraw <- readWorksheet(wb, sheet=getSheets(wb)[1], startRow=1)
dat2 <- cbind(dat1, datraw[match(dat1$ID, datraw$ID.), paste0("L", 1:31)])
ltrussvars <- paste0("L", 1:31)
rtrussvars <- paste0("r", 1:31)
doc <- startrtf(file="CiscoMorph", dir="C:/JVA/Consult/Yule/CiscoMorpho")
heading("Exploring Dan's Cisco Morphometrics Data")
heading("Jean V. Adams - 3 July 2014", 2)
para("There was one row in the cisco morphometrics data with missing truss measurements (Table ", tabcount, ").",
"  This row was eliminated from further analysis.")
tab <- dat2[is.na(dat2$L1), c("OBS", "ID", "SEX", "AGE", "LAKE", "SITE", "LS", "TL", ltrussvars[1:5])]
tabl("Records with missing truss measurements.", row.names=FALSE)
sethdat <- dat2[!is.na(dat2$L1), ]
para("There were a few rows in the cisco morphometrics data with duplicate IDs.",
"  Most of the measurements were pretty close, but a few were a bit further off (Table ", tabcount, ").",
"  Dan checked into these, and could only find photos for OBSs 563 and 675,",
" so all of the other observations were removed prior to analysis.")
a <- sethdat[sethdat$ID %in% sethdat$ID[duplicated(sethdat$ID)], ]
b <- a[c(1, 3, 5, 7, 9), rtrussvars] - a[c(2, 4, 6, 8, 10), rtrussvars]
#plot(sort(abs(unlist(b))))
tab <- a[, c(1:7, 7+c(9, 16, 28, 29))]
tab[, 8:11] <- format(round(tab[, 8:11], 2))
tabl("Records with duplicate IDs.  Truss measurements are given for those measures that were off by more than 0.3.", row.names=FALSE)
sethdat <- sethdat[!(sethdat$OBS %in% tab$OBS[!(tab$OBS %in% c(563, 675))]), ]
para("Prior to analysis, the size component was removed from the morphometric measures.",
"  Truss measurements (in mm) were natural log transformed, and the first principal component",
" (based on the covariance matrix) of these measures was used as general measure of size (Figure ", figcount, ").")
# log transform the lengths
ldat <- log(sethdat[, ltrussvars])
# use the first principal component as size
size <- princomp(ldat, cor=FALSE, scores=TRUE)$scores[, 1]
fig <- function() {
par(mar=c(4, 4, 1, 1))
plot(sethdat$TL, size, xlab="Total length of fish  (mm)", ylab="General measure of size  (PC1)", las=1)
}
figu("Relation between fish total length and derived general measure of fish size based on the first",
" principal component score of the log transformed truss measurements.", h=4, w=4)
# regress size (x) on each of the log transformed lengths (y) to get a residual
rdat <- sapply(ldat, function(y) lm(y ~ size)$resid)
dimnames(rdat)[[2]] <- rtrussvars
dat <- cbind(sethdat[, c("OBS", "ID", "SEX", "AGE", "LAKE", "SITE", "LS", "TL", ltrussvars)], size, rdat)
# write.csv(dat, "C:/JVA/Consult/Yule/CiscoMorpho/Cisco morpho with Jean residuals.csv", row.names=FALSE)
if(FALSE) {
# compare new resids to Seth's resids
windows()
plot(rdat[, 15], sethdat[, rtrussvars][, 15])
lm(sethdat[, rtrussvars][, 15] ~ rdat[, 15])
# compare new resids to Seth's resids
windows()
plot(rdat[, 25], sethdat[, rtrussvars][, 25])
lm(sethdat[, rtrussvars][, 25] ~ rdat[, 25])
}
rm(wb, dat1, datraw, dat2, sethdat, a, b, ldat, size, rdat)
para("There were also ", sum(is.na(dat$SEX)), " records where sex was missing (Table ", tabcount, ").")
a <- table(dat$LS[is.na(dat$SEX)])
tab <- data.frame(LakeSite=names(a), Nrecords=as.numeric(a))
tabl("Number of records, by lake and site, with nothing entered for sex.", row.names=FALSE)
para("And ", sum(!is.na(dat$SEX) & !(dat$SEX %in% 1:2)), " records where sex was not equal to 1 or 2 (Table ", tabcount, ").")
tab <- dat[!is.na(dat$SEX) & !(dat$SEX %in% 1:2), 1:10]
tab[, 8:10] <- round(tab[, 8:10], 2)
tabl("Records with sex not equal to 1 or 2.", row.names=FALSE)
para("For analyses conducted for individual sexes, I used only those records with sex equal to 1 (males) or 2 (females) .",
"  In all cases (both sexes, just males, and just females),",
" I scaled the data (subtracting the mean and dividing by the standard deviation),",
" so that all of the truss measurements would have the same mean and variance.",
"  This ensures that each truss measure will be given the same amount of weight in a cluster analysis.")
# subset the data
submf <- dat[!duplicated(dat$ID), ]
subm <- dat[!duplicated(dat$ID) & !is.na(dat$SEX) & dat$SEX==1, ]
subf <- dat[!duplicated(dat$ID) & !is.na(dat$SEX) & dat$SEX==2, ]
# rescale the data
subscmf <- scale(submf[, rtrussvars])
subscm <- scale(subm[, rtrussvars])
subscf <- scale(subf[, rtrussvars])
# error check truss measurements
submftruss <- data.frame(t(submf[, ltrussvars]))
names(submftruss) <- submf$ID
fc1 <- lapply(submftruss, buildfish)
fc2 <- lapply(submftruss, buildfish, upfirst=FALSE)
fc1[sapply(fc1, function(x) any(is.na(x)))]
fc2[sapply(fc2, function(x) any(is.na(x)))]
buildfish(submf[submf$ID==106439, ltrussvars])
buildfish(submf[submf$ID==106439, ltrussvars], upfirst=FALSE)
sort(signif(submf[submf$ID==106439, ltrussvars], 3))
# error in ID 106439, L5=54.9, L10=182, L11=122 ... L10 too big??
t1 <- t(sapply(fc1, fc2truss))
t2 <- t(sapply(fc2, fc2truss))
r1 <- submf[, ltrussvars] - t1[, ltrussvars]
r2 <- submf[, ltrussvars] - t2[, ltrussvars] - 
mse1 <- sqrt(apply(r1^2, 1, sum))
mse2 <- sqrt(apply(r2^2, 1, sum))
sel <- mse1 > 20 | mse2 > 20
round(r1[sel, ])
round(r2[sel, ])
t1[sel, ]
t2[sel, ]
submf[sel, ]
?cheat
library(devtools)
setwd("C:/JVA/GitHub/jvamisc")
document()
q()
